

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>starbot.core.bot &mdash; Red - Discord Bot 3.5.14.dev2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=7ab3649f" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=629867fc"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Red - Discord Bot
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Installation Guides:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install_guides/index.html">Installing Red</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bot_application_guide.html">Creating a bot account</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../update_red.html">Updating Red</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../about_venv.html">About Virtual Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autostart_windows.html">Setting up auto-restart using batch on Windows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autostart_mac.html">Setting up auto-restart on Mac</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autostart_systemd.html">Setting up auto-restart using systemd on Linux</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Cog Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_customcom.html">CustomCommands Cog Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_permissions.html">Permissions Cog Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide_trivia_list_creation.html">Trivia List Creation Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User guides:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intents.html">About (privileged) intents and public bots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_guides/admin.html">Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_guides/alias.html">Alias</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_guides/audio.html">Audio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_guides/cleanup.html">Cleanup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_guides/cog_manager_ui.html">Cog Manager UI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_guides/core.html">Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_guides/customcommands.html">CustomCommands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_guides/dev.html">Dev</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_guides/downloader.html">Downloader</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_guides/economy.html">Economy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_guides/filter.html">Filter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_guides/general.html">General</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_guides/image.html">Image</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_guides/permissions.html">Permissions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_guides/mod.html">Mod</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_guides/modlog.html">ModLog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_guides/mutes.html">Mutes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_guides/reports.html">Reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_guides/streams.html">Streams</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_guides/trivia.html">Trivia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cog_guides/warnings.html">Warnings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../red_core_data_statement.html">Red and End User Data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Red Development Framework Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../guide_migration.html">Migrating cogs from Red V2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide_cog_creation.html">Creating cogs for Red V3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide_slash_and_interactions.html">Slash Commands and Interactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide_publish_cogs.html">Publishing cogs for Red V3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide_cog_creators.html">Becoming an Approved Cog Creator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../framework_apikeys.html">Shared API Keys</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../framework_bank.html">Bank</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../framework_bot.html">Bot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../framework_checks.html">Command Check Decorators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../framework_commands.html">Commands Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../framework_app_commands.html">App Commands Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../framework_config.html">Config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../framework_datamanager.html">Data Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../framework_events.html">Custom Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../framework_i18n.html">Internationalization Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../framework_modlog.html">Mod log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../framework_rpc.html">RPC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../framework_tree.html">Tree</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../framework_utils.html">Utility Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_guarantees.html">Versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_guarantees.html#end-user-guarantees">End-user Guarantees</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_guarantees.html#developer-guarantees">Developer Guarantees</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_guarantees.html#breaking-change-notices">Breaking Change Notices</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Others</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../incompatible_changes/index.html">Backward incompatible changes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../host-list.html">Hosting Information</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Red - Discord Bot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">starbot.core.bot</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">


           <div itemprop="articleBody">
             
  <h1>Source code for starbot.core.bot</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="nn">aiohttp</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">importlib.machinery</span> <span class="kn">import</span> <span class="n">ModuleSpec</span>
<span class="kn">from</span> <span class="nn">importlib.util</span> <span class="kn">import</span> <span class="n">module_from_spec</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">NoReturn</span><span class="p">,</span>
    <span class="n">Set</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Awaitable</span><span class="p">,</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Literal</span><span class="p">,</span>
    <span class="n">MutableMapping</span><span class="p">,</span>
    <span class="n">Set</span><span class="p">,</span>
    <span class="n">overload</span><span class="p">,</span>
    <span class="n">TYPE_CHECKING</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">MappingProxyType</span>

<span class="kn">import</span> <span class="nn">discord</span>
<span class="kn">from</span> <span class="nn">discord.ext</span> <span class="kn">import</span> <span class="n">commands</span> <span class="k">as</span> <span class="n">dpy_commands</span>
<span class="kn">from</span> <span class="nn">discord.ext.commands</span> <span class="kn">import</span> <span class="n">when_mentioned_or</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">Config</span><span class="p">,</span> <span class="n">app_commands</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">commands</span><span class="p">,</span> <span class="n">_drivers</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">i18n</span><span class="p">,</span> <span class="n">modlog</span>
<span class="kn">from</span> <span class="nn">._cli</span> <span class="kn">import</span> <span class="n">ExitCodes</span>
<span class="kn">from</span> <span class="nn">._cog_manager</span> <span class="kn">import</span> <span class="n">CogManager</span><span class="p">,</span> <span class="n">CogManagerUI</span>
<span class="kn">from</span> <span class="nn">.core_commands</span> <span class="kn">import</span> <span class="n">Core</span>
<span class="kn">from</span> <span class="nn">.data_manager</span> <span class="kn">import</span> <span class="n">cog_data_path</span>
<span class="kn">from</span> <span class="nn">.dev_commands</span> <span class="kn">import</span> <span class="n">Dev</span>
<span class="kn">from</span> <span class="nn">._events</span> <span class="kn">import</span> <span class="n">init_events</span>
<span class="kn">from</span> <span class="nn">._global_checks</span> <span class="kn">import</span> <span class="n">init_global_checks</span>
<span class="kn">from</span> <span class="nn">._settings_caches</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">PrefixManager</span><span class="p">,</span>
    <span class="n">IgnoreManager</span><span class="p">,</span>
    <span class="n">WhitelistBlacklistManager</span><span class="p">,</span>
    <span class="n">DisabledCogCache</span><span class="p">,</span>
    <span class="n">I18nManager</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">._rpc</span> <span class="kn">import</span> <span class="n">RPCMixin</span>
<span class="kn">from</span> <span class="nn">.tree</span> <span class="kn">import</span> <span class="n">RedTree</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">can_user_send_messages_in</span><span class="p">,</span> <span class="n">common_filters</span><span class="p">,</span> <span class="n">AsyncIter</span>
<span class="kn">from</span> <span class="nn">.utils.chat_formatting</span> <span class="kn">import</span> <span class="n">box</span><span class="p">,</span> <span class="n">text_to_file</span>
<span class="kn">from</span> <span class="nn">.utils.predicates</span> <span class="kn">import</span> <span class="n">MessagePredicate</span>
<span class="kn">from</span> <span class="nn">.utils._internal_utils</span> <span class="kn">import</span> <span class="n">send_to_owners_with_prefix_replaced</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">discord.ext.commands.hybrid</span> <span class="kn">import</span> <span class="n">CommandCallback</span><span class="p">,</span> <span class="n">ContextT</span><span class="p">,</span> <span class="n">P</span>


<span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T&quot;</span><span class="p">)</span>

<span class="n">CUSTOM_GROUPS</span> <span class="o">=</span> <span class="s2">&quot;CUSTOM_GROUPS&quot;</span>
<span class="n">COMMAND_SCOPE</span> <span class="o">=</span> <span class="s2">&quot;COMMAND&quot;</span>
<span class="n">SHARED_API_TOKENS</span> <span class="o">=</span> <span class="s2">&quot;SHARED_API_TOKENS&quot;</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;starbot&quot;</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Red&quot;</span><span class="p">,)</span>

<span class="n">NotMessage</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;NotMessage&quot;</span><span class="p">,</span> <span class="s2">&quot;guild&quot;</span><span class="p">)</span>

<span class="n">DataDeletionResults</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;DataDeletionResults&quot;</span><span class="p">,</span> <span class="s2">&quot;failed_modules failed_cogs unhandled&quot;</span><span class="p">)</span>

<span class="n">PreInvokeCoroutine</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">commands</span><span class="o">.</span><span class="n">Context</span><span class="p">],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
<span class="n">T_BIC</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T_BIC&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">PreInvokeCoroutine</span><span class="p">)</span>
<span class="n">UserOrRole</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">Role</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">Member</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">User</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_is_submodule</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">parent</span> <span class="o">==</span> <span class="n">child</span> <span class="ow">or</span> <span class="n">child</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">parent</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_NoOwnerSet</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when there is no owner set for the instance that is trying to start.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">DynamicShardedBot</span><span class="p">(</span><span class="n">commands</span><span class="o">.</span><span class="n">GroupMixin</span><span class="p">,</span> <span class="n">RPCMixin</span><span class="p">,</span> <span class="n">dpy_commands</span><span class="o">.</span><span class="n">AutoShardedBot</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom AutoShardedBot that dynamically manages shards.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">cli_flags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bot_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Calculate the shard count dynamically</span>
        <span class="n">shard_count</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;shard_count&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;shard_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shard_count</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Add additional initialization if needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_permissions_hooks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">commands</span><span class="o">.</span><span class="n">CheckPredicate</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_red_ready</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_red_before_invoke_objs</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">PreInvokeCoroutine</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deletion_requests</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">]</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Check if we need to adjust the shard count</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_shard_count</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">check_shard_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">guild_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">guilds</span><span class="p">)</span>
        <span class="n">required_shard_count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">guild_count</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)</span> <span class="o">//</span> <span class="mi">15</span><span class="p">)</span>  <span class="c1"># Ensure at least 1 shard</span>

        <span class="k">if</span> <span class="n">required_shard_count</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shard_count</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Adjusting shard count to </span><span class="si">{</span><span class="n">required_shard_count</span><span class="si">}</span><span class="s2"> due to </span><span class="si">{</span><span class="n">guild_count</span><span class="si">}</span><span class="s2"> guilds.&quot;</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_bot</span><span class="p">(</span><span class="n">required_shard_count</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">restart_bot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_shard_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># Save the new shard count to a file or environment variable as needed</span>
        <span class="c1"># For example, using an environment variable:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;DISCORD_SHARD_COUNT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_shard_count</span><span class="p">)</span>

        <span class="c1"># Restart the bot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_mode</span> <span class="o">=</span> <span class="n">ExitCodes</span><span class="o">.</span><span class="n">RESTART</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">ExitCodes</span><span class="o">.</span><span class="n">RESTART</span><span class="p">)</span>


<div class="viewcode-block" id="Red">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red">[docs]</a>
<span class="k">class</span> <span class="nc">Red</span><span class="p">(</span><span class="n">DynamicShardedBot</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Our subclass of discord.ext.commands.AutoShardedBot&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">cli_flags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bot_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_mode</span> <span class="o">=</span> <span class="n">ExitCodes</span><span class="o">.</span><span class="n">CRITICAL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cli_flags</span> <span class="o">=</span> <span class="n">cli_flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">get_core_conf</span><span class="p">(</span><span class="n">force_registration</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rpc_enabled</span> <span class="o">=</span> <span class="n">cli_flags</span><span class="o">.</span><span class="n">rpc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rpc_port</span> <span class="o">=</span> <span class="n">cli_flags</span><span class="o">.</span><span class="n">rpc_port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_exception</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">register_global</span><span class="p">(</span>
            <span class="n">token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">prefix</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">packages</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">owner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">whitelist</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">blacklist</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">locale</span><span class="o">=</span><span class="s2">&quot;en-US&quot;</span><span class="p">,</span>
            <span class="n">regional_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">embeds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="mi">15158332</span><span class="p">,</span>
            <span class="n">fuzzy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">custom_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">help__page_char_limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
            <span class="n">help__max_pages_in_guild</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">help__delete_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">help__use_menus</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">help__show_hidden</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help__show_aliases</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">help__verify_checks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">help__verify_exists</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help__tagline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">help__use_tick</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help__react_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;starbot Supreme&quot;</span><span class="p">,</span>
            <span class="n">invite_public</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">invite_perm</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">invite_commands_scope</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">disabled_commands</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">disabled_command_msg</span><span class="o">=</span><span class="s2">&quot;That command is disabled.&quot;</span><span class="p">,</span>
            <span class="n">invoke_error_msg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">extra_owner_destinations</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">owner_opt_out_list</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">last_system_info__python_version</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
            <span class="n">last_system_info__machine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">last_system_info__system</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">schema_version</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">datarequests__allow_user_requests</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">datarequests__user_requests_are_strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">use_buttons</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">enabled_slash_commands</span><span class="o">=</span><span class="p">{},</span>
            <span class="n">enabled_user_commands</span><span class="o">=</span><span class="p">{},</span>
            <span class="n">enabled_message_commands</span><span class="o">=</span><span class="p">{},</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">register_guild</span><span class="p">(</span>
            <span class="n">prefix</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">whitelist</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">blacklist</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">admin_role</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">mod_role</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">embeds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">ignored</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">use_bot_color</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">fuzzy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">disabled_commands</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">autoimmune_ids</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">delete_delay</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">locale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">regional_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">register_channel</span><span class="p">(</span><span class="n">embeds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignored</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">register_user</span><span class="p">(</span><span class="n">embeds</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">init_custom</span><span class="p">(</span><span class="s2">&quot;COG_DISABLE_SETTINGS&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">register_custom</span><span class="p">(</span><span class="s2">&quot;COG_DISABLE_SETTINGS&quot;</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">init_custom</span><span class="p">(</span><span class="n">CUSTOM_GROUPS</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">register_custom</span><span class="p">(</span><span class="n">CUSTOM_GROUPS</span><span class="p">)</span>

        <span class="c1"># {COMMAND_NAME: {GUILD_ID: {...}}}</span>
        <span class="c1"># GUILD_ID=0 for global setting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">init_custom</span><span class="p">(</span><span class="n">COMMAND_SCOPE</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">register_custom</span><span class="p">(</span><span class="n">COMMAND_SCOPE</span><span class="p">,</span> <span class="n">embeds</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="c1"># TODO: add cache for embed settings</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">init_custom</span><span class="p">(</span><span class="n">SHARED_API_TOKENS</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">register_custom</span><span class="p">(</span><span class="n">SHARED_API_TOKENS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prefix_cache</span> <span class="o">=</span> <span class="n">PrefixManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span> <span class="n">cli_flags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disabled_cog_cache</span> <span class="o">=</span> <span class="n">DisabledCogCache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ignored_cache</span> <span class="o">=</span> <span class="n">IgnoreManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_whiteblacklist_cache</span> <span class="o">=</span> <span class="n">WhitelistBlacklistManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_i18n_cache</span> <span class="o">=</span> <span class="n">I18nManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bypass_cooldowns</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">prefix_manager</span><span class="p">(</span><span class="n">bot</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
            <span class="n">prefixes</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefix_cache</span><span class="o">.</span><span class="n">get_prefixes</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">guild</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cli_flags</span><span class="o">.</span><span class="n">mentionable</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">when_mentioned_or</span><span class="p">(</span><span class="o">*</span><span class="n">prefixes</span><span class="p">)(</span><span class="n">bot</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">prefixes</span>

        <span class="k">if</span> <span class="s2">&quot;command_prefix&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;command_prefix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefix_manager</span>

        <span class="k">if</span> <span class="s2">&quot;owner_id&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;starbot doesn&#39;t accept owner_id kwarg, use owner_ids instead.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;intents&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">intents</span> <span class="o">=</span> <span class="n">discord</span><span class="o">.</span><span class="n">Intents</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">intent_name</span> <span class="ow">in</span> <span class="n">cli_flags</span><span class="o">.</span><span class="n">disable_intent</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">intents</span><span class="p">,</span> <span class="n">intent_name</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;intents&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">intents</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_owner_id_overwrite</span> <span class="o">=</span> <span class="n">cli_flags</span><span class="o">.</span><span class="n">owner</span>

        <span class="k">if</span> <span class="s2">&quot;owner_ids&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;owner_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;owner_ids&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;owner_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;owner_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cli_flags</span><span class="o">.</span><span class="n">co_owner</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;command_not_found&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;command_not_found&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Command </span><span class="si">{}</span><span class="s2"> not found.</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;allowed_mentions&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;allowed_mentions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">discord</span><span class="o">.</span><span class="n">AllowedMentions</span><span class="p">(</span><span class="n">everyone</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">roles</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">message_cache_size</span> <span class="o">=</span> <span class="n">cli_flags</span><span class="o">.</span><span class="n">message_cache_size</span>
        <span class="k">if</span> <span class="n">cli_flags</span><span class="o">.</span><span class="n">no_message_cache</span><span class="p">:</span>
            <span class="n">message_cache_size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;max_messages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message_cache_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_messages</span> <span class="o">=</span> <span class="n">message_cache_size</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_uptime</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checked_time_accuracy</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_main_dir</span> <span class="o">=</span> <span class="n">bot_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cog_mgr</span> <span class="o">=</span> <span class="n">CogManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_team_features</span> <span class="o">=</span> <span class="n">cli_flags</span><span class="o">.</span><span class="n">use_team_features</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">help_command</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tree_cls</span><span class="o">=</span><span class="n">RedTree</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Do not manually use the help formatter attribute here, see `send_help_for`,</span>
        <span class="c1"># for a documented API. The internals of this object are still subject to change.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_help_formatter</span> <span class="o">=</span> <span class="n">commands</span><span class="o">.</span><span class="n">help</span><span class="o">.</span><span class="n">RedHelpFormatter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">commands</span><span class="o">.</span><span class="n">help</span><span class="o">.</span><span class="n">red_help</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_permissions_hooks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">commands</span><span class="o">.</span><span class="n">CheckPredicate</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_red_ready</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_red_before_invoke_objs</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">PreInvokeCoroutine</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_deletion_requests</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">]</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">()</span>

<div class="viewcode-block" id="Red.set_help_formatter">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.set_help_formatter">[docs]</a>
    <span class="k">def</span> <span class="nf">set_help_formatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formatter</span><span class="p">:</span> <span class="n">commands</span><span class="o">.</span><span class="n">help</span><span class="o">.</span><span class="n">HelpFormatterABC</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set&#39;s starbot&#39;s help formatter.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This method is `provisional &lt;developer-guarantees-exclusions&gt;`.</span>


<span class="sd">        The formatter must implement all methods in</span>
<span class="sd">        ``commands.help.HelpFormatterABC``</span>

<span class="sd">        Cogs which set a help formatter should inform users of this.</span>
<span class="sd">        Users should not use multiple cogs which set a help formatter.</span>

<span class="sd">        This should specifically be an instance of a formatter.</span>
<span class="sd">        This allows cogs to pass a config object or similar to the</span>
<span class="sd">        formatter prior to the bot using it.</span>

<span class="sd">        See ``commands.help.HelpFormatterABC`` for more details.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If the default formatter has already been replaced</span>
<span class="sd">        TypeError</span>
<span class="sd">            If given an invalid formatter</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">formatter</span><span class="p">,</span> <span class="n">commands</span><span class="o">.</span><span class="n">help</span><span class="o">.</span><span class="n">HelpFormatterABC</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Help formatters must inherit from `commands.help.HelpFormatterABC` &quot;</span>
                <span class="s2">&quot;and implement the required interfaces.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># do not switch to isinstance, we want to know that this has not been overridden,</span>
        <span class="c1"># even with a subclass.</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_help_formatter</span><span class="p">)</span> <span class="ow">is</span> <span class="n">commands</span><span class="o">.</span><span class="n">help</span><span class="o">.</span><span class="n">RedHelpFormatter</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_help_formatter</span> <span class="o">=</span> <span class="n">formatter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The formatter has already been overridden.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Red.reset_help_formatter">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.reset_help_formatter">[docs]</a>
    <span class="k">def</span> <span class="nf">reset_help_formatter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resets Red&#39;s help formatter.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            This method is `provisional &lt;developer-guarantees-exclusions&gt;`.</span>


<span class="sd">        This exists for use in ``cog_unload`` for cogs which replace the formatter</span>
<span class="sd">        as well as for a rescue command in core_commands.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_help_formatter</span> <span class="o">=</span> <span class="n">commands</span><span class="o">.</span><span class="n">help</span><span class="o">.</span><span class="n">RedHelpFormatter</span><span class="p">()</span></div>


<div class="viewcode-block" id="Red.add_dev_env_value">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.add_dev_env_value">[docs]</a>
    <span class="k">def</span> <span class="nf">add_dev_env_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">commands</span><span class="o">.</span><span class="n">Context</span><span class="p">],</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a custom variable to the dev environment (``[p]debug``, ``[p]eval``, and ``[p]repl`` commands).</span>
<span class="sd">        If dev mode is disabled, nothing will happen.</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            class MyCog(commands.Cog):</span>
<span class="sd">                def __init__(self, bot):</span>
<span class="sd">                    self.bot = bot</span>
<span class="sd">                    bot.add_dev_env_value(&quot;mycog&quot;, lambda ctx: self)</span>
<span class="sd">                    bot.add_dev_env_value(&quot;mycogdata&quot;, lambda ctx: self.settings[ctx.guild.id])</span>

<span class="sd">                def cog_unload(self):</span>
<span class="sd">                    self.bot.remove_dev_env_value(&quot;mycog&quot;)</span>
<span class="sd">                    self.bot.remove_dev_env_value(&quot;mycogdata&quot;)</span>

<span class="sd">        Once your cog is loaded, the custom variables ``mycog`` and ``mycogdata``</span>
<span class="sd">        will be included in the environment of dev commands.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">            The name of your custom variable.</span>
<span class="sd">        value: Callable[[commands.Context], Any]</span>
<span class="sd">            The function returning the value of the variable.</span>
<span class="sd">            It must take a `commands.Context` as its sole parameter</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            ``value`` argument isn&#39;t a callable.</span>
<span class="sd">        ValueError</span>
<span class="sd">            The passed callable takes no or more than one argument.</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            The name of the custom variable is either reserved by a variable</span>
<span class="sd">            from the default environment or already taken by some other custom variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">signature</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Callable must take exactly one argument for context&quot;</span><span class="p">)</span>
        <span class="n">dev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cog</span><span class="p">(</span><span class="s2">&quot;Dev&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dev</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;bot&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ctx&quot;</span><span class="p">,</span>
            <span class="s2">&quot;channel&quot;</span><span class="p">,</span>
            <span class="s2">&quot;author&quot;</span><span class="p">,</span>
            <span class="s2">&quot;guild&quot;</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">,</span>
            <span class="s2">&quot;asyncio&quot;</span><span class="p">,</span>
            <span class="s2">&quot;aiohttp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;discord&quot;</span><span class="p">,</span>
            <span class="s2">&quot;commands&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_&quot;</span><span class="p">,</span>
            <span class="s2">&quot;__name__&quot;</span><span class="p">,</span>
            <span class="s2">&quot;__builtins__&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The name </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is reserved for default environment.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dev</span><span class="o">.</span><span class="n">env_extensions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The name </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is already used.&quot;</span><span class="p">)</span>
        <span class="n">dev</span><span class="o">.</span><span class="n">env_extensions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="Red.remove_dev_env_value">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.remove_dev_env_value">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_dev_env_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove a custom variable from the dev environment.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">            The name of the custom variable.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        KeyError</span>
<span class="sd">            The custom variable was never set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cog</span><span class="p">(</span><span class="s2">&quot;Dev&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dev</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">del</span> <span class="n">dev</span><span class="o">.</span><span class="n">env_extensions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>


<div class="viewcode-block" id="Red.get_command">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.get_command">[docs]</a>
    <span class="k">def</span> <span class="nf">get_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">commands</span><span class="o">.</span><span class="n">Command</span><span class="p">]:</span>
        <span class="n">com</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_command</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">com</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">com</span><span class="p">,</span> <span class="n">commands</span><span class="o">.</span><span class="n">Command</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">com</span></div>


<div class="viewcode-block" id="Red.get_cog">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.get_cog">[docs]</a>
    <span class="k">def</span> <span class="nf">get_cog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">commands</span><span class="o">.</span><span class="n">Cog</span><span class="p">]:</span>
        <span class="n">cog</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_cog</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">cog</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cog</span><span class="p">,</span> <span class="n">commands</span><span class="o">.</span><span class="n">Cog</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cog</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_before_invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># DEP-WARN</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_red_before_invoke_method</span>

    <span class="nd">@_before_invoke</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">_before_invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>  <span class="c1"># DEP-WARN</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prevent this from being overwritten in super().__init__&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_red_before_invoke_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_until_red_ready</span><span class="p">()</span>
        <span class="n">return_exceptions</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="n">commands</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">_RuleDropper</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_red_before_invoke_objs</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
                <span class="o">*</span><span class="p">(</span><span class="n">coro</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="k">for</span> <span class="n">coro</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_red_before_invoke_objs</span><span class="p">),</span>
                <span class="n">return_exceptions</span><span class="o">=</span><span class="n">return_exceptions</span><span class="p">,</span>
            <span class="p">)</span>

<div class="viewcode-block" id="Red.cog_disabled_in_guild">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.cog_disabled_in_guild">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">cog_disabled_in_guild</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cog</span><span class="p">:</span> <span class="n">commands</span><span class="o">.</span><span class="n">Cog</span><span class="p">,</span> <span class="n">guild</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">Guild</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a cog is disabled in a guild</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cog: commands.Cog</span>
<span class="sd">        guild: Optional[discord.Guild]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">guild</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disabled_cog_cache</span><span class="o">.</span><span class="n">cog_disabled_in_guild</span><span class="p">(</span><span class="n">cog</span><span class="o">.</span><span class="n">qualified_name</span><span class="p">,</span> <span class="n">guild</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></div>


<div class="viewcode-block" id="Red.cog_disabled_in_guild_raw">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.cog_disabled_in_guild_raw">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">cog_disabled_in_guild_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cog_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a cog is disabled in a guild without the cog or guild object</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cog_name: str</span>
<span class="sd">            This should be the cog&#39;s qualified name, not necessarily the classname</span>
<span class="sd">        guild_id: int</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disabled_cog_cache</span><span class="o">.</span><span class="n">cog_disabled_in_guild</span><span class="p">(</span><span class="n">cog_name</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="Red.remove_before_invoke_hook">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.remove_before_invoke_hook">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_before_invoke_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coro</span><span class="p">:</span> <span class="n">PreInvokeCoroutine</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Functional method to remove a `before_invoke` hook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_red_before_invoke_objs</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span></div>


<div class="viewcode-block" id="Red.before_invoke">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.before_invoke">[docs]</a>
    <span class="k">def</span> <span class="nf">before_invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coro</span><span class="p">:</span> <span class="n">T_BIC</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T_BIC</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overridden decorator method for Red&#39;s ``before_invoke`` behavior.</span>

<span class="sd">        This can safely be used purely functionally as well.</span>

<span class="sd">        3rd party cogs should remove any hooks which they register at unload</span>
<span class="sd">        using `remove_before_invoke_hook`</span>

<span class="sd">        Below behavior shared with discord.py:</span>

<span class="sd">        .. note::</span>
<span class="sd">            The ``before_invoke`` hooks are</span>
<span class="sd">            only called if all checks and argument parsing procedures pass</span>
<span class="sd">            without error. If any check or argument parsing procedures fail</span>
<span class="sd">            then the hooks are not called.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coro: Callable[[commands.Context], Awaitable[Any]]</span>
<span class="sd">            The coroutine to register as the pre-invoke hook.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            The coroutine passed is not actually a coroutine.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">coro</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The pre-invoke hook must be a coroutine.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_red_before_invoke_objs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">coro</span></div>


<div class="viewcode-block" id="Red.before_identify_hook">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.before_identify_hook">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">before_identify_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shard_id</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A hook that is called before IDENTIFYing a session.</span>
<span class="sd">        Same as in discord.py, but also dispatches &quot;on_red_identify&quot; bot event.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="s2">&quot;red_before_identify&quot;</span><span class="p">,</span> <span class="n">shard_id</span><span class="p">,</span> <span class="n">initial</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">before_identify_hook</span><span class="p">(</span><span class="n">shard_id</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="n">initial</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cog_mgr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Please don&#39;t mess with the cog manager internals.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uptime</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Allow access to the value, but we don&#39;t want cog creators setting it&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uptime</span>

    <span class="nd">@uptime</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">uptime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Hey, we&#39;re cool with sharing info about the uptime, but don&#39;t try and assign to it please.&quot;</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">db</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
            <span class="s2">&quot;We really don&#39;t want you touching the bot config directly. &quot;</span>
            <span class="s2">&quot;If you need something in here, take a look at the exposed methods &quot;</span>
            <span class="s2">&quot;and use the one which corresponds to your needs or &quot;</span>
            <span class="s2">&quot;open an issue if you need an additional method for your use case.&quot;</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">counter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
            <span class="s2">&quot;Please make your own counter object by importing ``Counter`` from ``collections``.&quot;</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">color</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Please fetch the embed color with `get_embed_color`&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">colour</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Please fetch the embed colour with `get_embed_colour`&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_messages</span>

<div class="viewcode-block" id="Red.add_to_blacklist">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.add_to_blacklist">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">add_to_blacklist</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">users_or_roles</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">UserOrRole</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">guild</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">Guild</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add users or roles to the global or local blocklist.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        users_or_roles : Iterable[Union[int, discord.Role, discord.Member, discord.User]]</span>
<span class="sd">            The items to add to the blocklist.</span>
<span class="sd">            Roles and role IDs should only be passed when updating a local blocklist.</span>
<span class="sd">        guild : Optional[discord.Guild]</span>
<span class="sd">            The guild, whose local blocklist should be modified.</span>
<span class="sd">            If not passed, the global blocklist will be modified.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            The values passed were not of the proper type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">to_add</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">uor</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">uor</span><span class="p">)</span> <span class="k">for</span> <span class="n">uor</span> <span class="ow">in</span> <span class="n">users_or_roles</span><span class="p">}</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_whiteblacklist_cache</span><span class="o">.</span><span class="n">add_to_blacklist</span><span class="p">(</span><span class="n">guild</span><span class="p">,</span> <span class="n">to_add</span><span class="p">)</span></div>


<div class="viewcode-block" id="Red.remove_from_blacklist">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.remove_from_blacklist">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">remove_from_blacklist</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">users_or_roles</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">UserOrRole</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">guild</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">Guild</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove users or roles from the global or local blocklist.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        users_or_roles : Iterable[Union[int, discord.Role, discord.Member, discord.User]]</span>
<span class="sd">            The items to remove from the blocklist.</span>
<span class="sd">            Roles and role IDs should only be passed when updating a local blocklist.</span>
<span class="sd">        guild : Optional[discord.Guild]</span>
<span class="sd">            The guild, whose local blocklist should be modified.</span>
<span class="sd">            If not passed, the global blocklist will be modified.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            The values passed were not of the proper type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">to_remove</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">uor</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">uor</span><span class="p">)</span> <span class="k">for</span> <span class="n">uor</span> <span class="ow">in</span> <span class="n">users_or_roles</span><span class="p">}</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_whiteblacklist_cache</span><span class="o">.</span><span class="n">remove_from_blacklist</span><span class="p">(</span><span class="n">guild</span><span class="p">,</span> <span class="n">to_remove</span><span class="p">)</span></div>


<div class="viewcode-block" id="Red.get_blacklist">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.get_blacklist">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_blacklist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">Guild</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the global or local blocklist.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        guild : Optional[discord.Guild]</span>
<span class="sd">            The guild to get the local blocklist for.</span>
<span class="sd">            If this is not passed, the global blocklist will be returned.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Set[int]</span>
<span class="sd">            The IDs of the blocked users/roles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_whiteblacklist_cache</span><span class="o">.</span><span class="n">get_blacklist</span><span class="p">(</span><span class="n">guild</span><span class="p">)</span></div>


<div class="viewcode-block" id="Red.clear_blacklist">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.clear_blacklist">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">clear_blacklist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">Guild</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the global or local blocklist.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        guild : Optional[discord.Guild]</span>
<span class="sd">            The guild, whose local blocklist should be cleared.</span>
<span class="sd">            If not passed, the global blocklist will be cleared.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_whiteblacklist_cache</span><span class="o">.</span><span class="n">clear_blacklist</span><span class="p">(</span><span class="n">guild</span><span class="p">)</span></div>


<div class="viewcode-block" id="Red.add_to_whitelist">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.add_to_whitelist">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">add_to_whitelist</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">users_or_roles</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">UserOrRole</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">guild</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">Guild</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add users or roles to the global or local allowlist.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        users_or_roles : Iterable[Union[int, discord.Role, discord.Member, discord.User]]</span>
<span class="sd">            The items to add to the allowlist.</span>
<span class="sd">            Roles and role IDs should only be passed when updating a local allowlist.</span>
<span class="sd">        guild : Optional[discord.Guild]</span>
<span class="sd">            The guild, whose local allowlist should be modified.</span>
<span class="sd">            If not passed, the global allowlist will be modified.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            The passed values were not of the proper type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">to_add</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">uor</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">uor</span><span class="p">)</span> <span class="k">for</span> <span class="n">uor</span> <span class="ow">in</span> <span class="n">users_or_roles</span><span class="p">}</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_whiteblacklist_cache</span><span class="o">.</span><span class="n">add_to_whitelist</span><span class="p">(</span><span class="n">guild</span><span class="p">,</span> <span class="n">to_add</span><span class="p">)</span></div>


<div class="viewcode-block" id="Red.remove_from_whitelist">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.remove_from_whitelist">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">remove_from_whitelist</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">users_or_roles</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">UserOrRole</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">guild</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">Guild</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove users or roles from the global or local allowlist.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        users_or_roles : Iterable[Union[int, discord.Role, discord.Member, discord.User]]</span>
<span class="sd">            The items to remove from the allowlist.</span>
<span class="sd">            Roles and role IDs should only be passed when updating a local allowlist.</span>
<span class="sd">        guild : Optional[discord.Guild]</span>
<span class="sd">            The guild, whose local allowlist should be modified.</span>
<span class="sd">            If not passed, the global allowlist will be modified.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            The passed values were not of the proper type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">to_remove</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">uor</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">uor</span><span class="p">)</span> <span class="k">for</span> <span class="n">uor</span> <span class="ow">in</span> <span class="n">users_or_roles</span><span class="p">}</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_whiteblacklist_cache</span><span class="o">.</span><span class="n">remove_from_whitelist</span><span class="p">(</span><span class="n">guild</span><span class="p">,</span> <span class="n">to_remove</span><span class="p">)</span></div>


<div class="viewcode-block" id="Red.get_whitelist">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.get_whitelist">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_whitelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">Guild</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the global or local allowlist.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        guild : Optional[discord.Guild]</span>
<span class="sd">            The guild to get the local allowlist for.</span>
<span class="sd">            If this is not passed, the global allowlist will be returned.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Set[int]</span>
<span class="sd">            The IDs of the allowed users/roles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_whiteblacklist_cache</span><span class="o">.</span><span class="n">get_whitelist</span><span class="p">(</span><span class="n">guild</span><span class="p">)</span></div>


<div class="viewcode-block" id="Red.clear_whitelist">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.clear_whitelist">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">clear_whitelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">Guild</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the global or local allowlist.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        guild : Optional[discord.Guild]</span>
<span class="sd">            The guild, whose local allowlist should be cleared.</span>
<span class="sd">            If not passed, the global allowlist will be cleared.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_whiteblacklist_cache</span><span class="o">.</span><span class="n">clear_whitelist</span><span class="p">(</span><span class="n">guild</span><span class="p">)</span></div>


<div class="viewcode-block" id="Red.allowed_by_whitelist_blacklist">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.allowed_by_whitelist_blacklist">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">allowed_by_whitelist_blacklist</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">who</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">Member</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">User</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">who_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">guild</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">Guild</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">role_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This checks if a user or member is allowed to run things,</span>
<span class="sd">        as considered by Red&#39;s allowlist and blocklist.</span>

<span class="sd">        If given a user object, this function will check the global lists</span>

<span class="sd">        If given a member, this will additionally check guild lists</span>

<span class="sd">        If omitting a user or member, you must provide a value for ``who_id``</span>

<span class="sd">        You may also provide a value for ``guild`` in this case</span>

<span class="sd">        If providing a member by guild and member ids,</span>
<span class="sd">        you should supply ``role_ids`` as well</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        who : Optional[Union[discord.Member, discord.User]]</span>
<span class="sd">            The user or member object to check</span>

<span class="sd">        Other Parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        who_id : Optional[int]</span>
<span class="sd">            The id of the user or member to check</span>
<span class="sd">            If not providing a value for ``who``, this is a required parameter.</span>
<span class="sd">        guild : Optional[discord.Guild]</span>
<span class="sd">            When used in conjunction with a provided value for ``who_id``, checks</span>
<span class="sd">            the lists for the corresponding guild as well.</span>
<span class="sd">            This is ignored when ``who`` is passed.</span>
<span class="sd">        role_ids : Optional[List[int]]</span>
<span class="sd">            When used with both ``who_id`` and ``guild``, checks the role ids provided.</span>
<span class="sd">            This is required for accurate checking of members in a guild if providing ids.</span>
<span class="sd">            This is ignored when ``who`` is passed.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            Did not provide ``who`` or ``who_id``</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            `True` if user is allowed to run things, `False` otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Contributor Note:</span>
        <span class="c1"># All config calls are delayed until needed in this section</span>
        <span class="c1"># All changes should be made keeping in mind that this is also used as a global check</span>

        <span class="n">mocked</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># used for an accurate delayed role id expansion later.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">who</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">who_id</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Must provide a value for either `who` or `who_id`&quot;</span><span class="p">)</span>
            <span class="n">mocked</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">who</span> <span class="o">=</span> <span class="n">discord</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">who_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">guild</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">who</span><span class="p">,</span> <span class="s2">&quot;guild&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_owner</span><span class="p">(</span><span class="n">who</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">global_whitelist</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_whitelist</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">global_whitelist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">who</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">global_whitelist</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># blacklist is only used when whitelist doesn&#39;t exist.</span>
            <span class="n">global_blacklist</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_blacklist</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">who</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">global_blacklist</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">guild</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">guild</span><span class="o">.</span><span class="n">owner_id</span> <span class="o">==</span> <span class="n">who</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="c1"># The delayed expansion of ids to check saves time in the DM case.</span>
            <span class="c1"># Converting to a set reduces the total lookup time in section</span>
            <span class="k">if</span> <span class="n">mocked</span><span class="p">:</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">who</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">role_ids</span> <span class="ow">or</span> <span class="p">[]))</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">guild</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># DEP-WARN</span>
                <span class="c1"># This uses member._roles (getattr is for the user case)</span>
                <span class="c1"># If this is removed upstream (undocumented)</span>
                <span class="c1"># there is a silent failure potential, and role blacklist/whitelists will break.</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">who</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">who</span><span class="p">,</span> <span class="s2">&quot;_roles&quot;</span><span class="p">,</span> <span class="p">[])))</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">guild</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>

            <span class="n">guild_whitelist</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_whitelist</span><span class="p">(</span><span class="n">guild</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">guild_whitelist</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ids</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">guild_whitelist</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">guild_blacklist</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_blacklist</span><span class="p">(</span><span class="n">guild</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">guild_blacklist</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Red.message_eligible_as_command">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.message_eligible_as_command">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">message_eligible_as_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">discord</span><span class="o">.</span><span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs through the things which apply globally about commands</span>
<span class="sd">        to determine if a message may be responded to as a command.</span>

<span class="sd">        This can&#39;t interact with permissions as permissions is hyper-local</span>
<span class="sd">        with respect to command objects, create command objects for this</span>
<span class="sd">        if that&#39;s needed.</span>

<span class="sd">        This also does not check for prefix or command conflicts,</span>
<span class="sd">        as it is primarily designed for non-prefix based response handling</span>
<span class="sd">        via on_message_without_command</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        message</span>
<span class="sd">            The message object to check</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            Whether or not the message is eligible to be treated as a command.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">channel</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">channel</span>
        <span class="n">guild</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">guild</span>

        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">bot</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># We do not consider messages with PartialMessageable channel as eligible.</span>
        <span class="c1"># See `process_commands()` for our handling of it.</span>

        <span class="c1"># 27-03-2023: Addendum, DMs won&#39;t run into the same issues that guild partials will,</span>
        <span class="c1"># so we can safely continue to execute the command.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">PartialMessageable</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">channel</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">discord</span><span class="o">.</span><span class="n">ChannelType</span><span class="o">.</span><span class="n">private</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">guild</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">channel</span><span class="p">,</span>
                <span class="p">(</span><span class="n">discord</span><span class="o">.</span><span class="n">TextChannel</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">VoiceChannel</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">StageChannel</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">Thread</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">can_user_send_messages_in</span><span class="p">(</span><span class="n">guild</span><span class="o">.</span><span class="n">me</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignored_channel_or_guild</span><span class="p">(</span><span class="n">message</span><span class="p">)):</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_by_whitelist_blacklist</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">author</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Red.ignored_channel_or_guild">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.ignored_channel_or_guild">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">ignored_channel_or_guild</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">commands</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">Message</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">Interaction</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This checks if the bot is meant to be ignoring commands in a channel or guild,</span>
<span class="sd">        as considered by Red&#39;s whitelist and blacklist.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ctx :</span>
<span class="sd">            Context object of the command which needs to be checked prior to invoking</span>
<span class="sd">            or a Message object which might be intended for use as a command</span>
<span class="sd">            or an Interaction object which might be intended for use with a command.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            `True` if commands are allowed in the channel, `False` otherwise</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            ``ctx.channel`` is a `discord.PartialMessageable` with a ``type`` other</span>
<span class="sd">            than ``discord.ChannelType.private``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">Interaction</span><span class="p">):</span>
            <span class="n">author</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">user</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">author</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">author</span>

        <span class="n">is_private</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">PrivateChannel</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">PartialMessageable</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">discord</span><span class="o">.</span><span class="n">ChannelType</span><span class="o">.</span><span class="n">private</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t check permissions for non-private PartialMessageable.&quot;</span><span class="p">)</span>
            <span class="n">is_private</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">perms</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">permissions_for</span><span class="p">(</span><span class="n">author</span><span class="p">)</span>
        <span class="n">surpass_ignore</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">is_private</span>
            <span class="ow">or</span> <span class="n">perms</span><span class="o">.</span><span class="n">manage_guild</span>
            <span class="ow">or</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_owner</span><span class="p">(</span><span class="n">author</span><span class="p">)</span>
            <span class="ow">or</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_admin</span><span class="p">(</span><span class="n">author</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># guild-wide checks</span>
        <span class="k">if</span> <span class="n">surpass_ignore</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">guild_ignored</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignored_cache</span><span class="o">.</span><span class="n">get_ignored_guild</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">guild</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">guild_ignored</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># (parent) channel checks</span>
        <span class="k">if</span> <span class="n">perms</span><span class="o">.</span><span class="n">manage_channels</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">parent</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">channel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">channel</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">chann_ignored</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignored_cache</span><span class="o">.</span><span class="n">get_ignored_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">chann_ignored</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">thread</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># thread checks</span>
        <span class="k">if</span> <span class="n">perms</span><span class="o">.</span><span class="n">manage_threads</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">thread_ignored</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignored_cache</span><span class="o">.</span><span class="n">get_ignored_channel</span><span class="p">(</span>
            <span class="n">thread</span><span class="p">,</span>
            <span class="n">check_category</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># already checked for parent</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">thread_ignored</span></div>


<div class="viewcode-block" id="Red.get_valid_prefixes">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.get_valid_prefixes">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_valid_prefixes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">Guild</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This gets the valid prefixes for a guild.</span>

<span class="sd">        If not provided a guild (or passed None) it will give the DM prefixes.</span>

<span class="sd">        This is just a fancy wrapper around ``get_prefix``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        guild : Optional[discord.Guild]</span>
<span class="sd">            The guild you want prefixes for. Omit (or pass None) for the DM prefixes</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[str]</span>
<span class="sd">            If a guild was specified, the valid prefixes in that guild.</span>
<span class="sd">            If a guild was not specified, the valid prefixes for DMs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prefix</span><span class="p">(</span><span class="n">NotMessage</span><span class="p">(</span><span class="n">guild</span><span class="p">))</span></div>


<div class="viewcode-block" id="Red.set_prefixes">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.set_prefixes">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">set_prefixes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefixes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">guild</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">Guild</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set global/server prefixes.</span>

<span class="sd">        If ``guild`` is not provided (or None is passed), this will set the global prefixes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prefixes : List[str]</span>
<span class="sd">            The prefixes you want to set. Passing empty list will reset prefixes for the ``guild``</span>
<span class="sd">        guild : Optional[discord.Guild]</span>
<span class="sd">            The guild you want to set the prefixes for. Omit (or pass None) to set the global prefixes</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If ``prefixes`` is not a list of strings</span>
<span class="sd">        ValueError</span>
<span class="sd">            If empty list is passed to ``prefixes`` when setting global prefixes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefix_cache</span><span class="o">.</span><span class="n">set_prefixes</span><span class="p">(</span><span class="n">guild</span><span class="o">=</span><span class="n">guild</span><span class="p">,</span> <span class="n">prefixes</span><span class="o">=</span><span class="n">prefixes</span><span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_embed_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="n">discord</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Messageable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">discord</span><span class="o">.</span><span class="n">Color</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the embed color for a location. This takes into account all related settings.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        location : `discord.abc.Messageable`</span>
<span class="sd">            Location to check embed color for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        discord.Color</span>
<span class="sd">            Embed color for the provided location.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">guild</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="s2">&quot;guild&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">guild</span>
            <span class="ow">and</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">guild</span><span class="p">(</span><span class="n">guild</span><span class="p">)</span><span class="o">.</span><span class="n">use_bot_color</span><span class="p">()</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">Member</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">guild</span><span class="o">.</span><span class="n">me</span><span class="o">.</span><span class="n">color</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_color</span>

<div class="viewcode-block" id="Red.get_or_fetch_user">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.get_or_fetch_user">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_or_fetch_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">discord</span><span class="o">.</span><span class="n">User</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves a `discord.User` based on their ID.</span>
<span class="sd">        You do not have to share any guilds</span>
<span class="sd">        with the user to get this information, however many operations</span>
<span class="sd">        do require that you do.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            This method may make an API call if the user is not found in the bot cache. For general usage, consider ``bot.get_user`` instead.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        user_id: int</span>
<span class="sd">            The ID of the user that should be retrieved.</span>

<span class="sd">        Raises</span>
<span class="sd">        -------</span>
<span class="sd">        Errors</span>
<span class="sd">            Please refer to `discord.Client.fetch_user`.</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        discord.User</span>
<span class="sd">            The user you requested.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">user</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="Red.get_or_fetch_member">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.get_or_fetch_member">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_or_fetch_member</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild</span><span class="p">:</span> <span class="n">discord</span><span class="o">.</span><span class="n">Guild</span><span class="p">,</span> <span class="n">member_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">discord</span><span class="o">.</span><span class="n">Member</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves a `discord.Member` from a guild and a member ID.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            This method may make an API call if the user is not found in the bot cache. For general usage, consider ``discord.Guild.get_member`` instead.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        guild: discord.Guild</span>
<span class="sd">            The guild which the member should be retrieved from.</span>
<span class="sd">        member_id: int</span>
<span class="sd">            The ID of the member that should be retrieved.</span>

<span class="sd">        Raises</span>
<span class="sd">        -------</span>
<span class="sd">        Errors</span>
<span class="sd">            Please refer to `discord.Guild.fetch_member`.</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        discord.Member</span>
<span class="sd">            The user you requested.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">member</span> <span class="o">:=</span> <span class="n">guild</span><span class="o">.</span><span class="n">get_member</span><span class="p">(</span><span class="n">member_id</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">member</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">guild</span><span class="o">.</span><span class="n">fetch_member</span><span class="p">(</span><span class="n">member_id</span><span class="p">)</span></div>


    <span class="n">get_embed_colour</span> <span class="o">=</span> <span class="n">get_embed_color</span>

    <span class="c1"># start config migrations</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_maybe_update_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This should be run prior to loading cogs or connecting to discord.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">schema_version</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">schema_version</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">schema_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema_0_to_1</span><span class="p">()</span>
            <span class="n">schema_version</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">schema_version</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">schema_version</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">schema_version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema_1_to_2</span><span class="p">()</span>
            <span class="n">schema_version</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">schema_version</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">schema_version</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">schema_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema_2_to_3</span><span class="p">()</span>
            <span class="n">schema_version</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">schema_version</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">schema_version</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_schema_2_to_3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Migrating help menus to enum values&quot;</span><span class="p">)</span>
        <span class="n">old</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">help__use_menus</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">help__use_menus</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">old</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_schema_1_to_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This contains the migration of shared API tokens to a custom config scope</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Moving shared API tokens to a custom group&quot;</span><span class="p">)</span>
        <span class="n">all_shared_api_tokens</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">get_raw</span><span class="p">(</span><span class="s2">&quot;api_tokens&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">{})</span>
        <span class="k">for</span> <span class="n">service_name</span><span class="p">,</span> <span class="n">token_mapping</span> <span class="ow">in</span> <span class="n">all_shared_api_tokens</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">service_partial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">custom</span><span class="p">(</span><span class="n">SHARED_API_TOKENS</span><span class="p">,</span> <span class="n">service_name</span><span class="p">)</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">service_partial</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">as</span> <span class="n">basically_bulk_update</span><span class="p">:</span>
                <span class="n">basically_bulk_update</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">token_mapping</span><span class="p">)</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">clear_raw</span><span class="p">(</span><span class="s2">&quot;api_tokens&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_schema_0_to_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This contains the migration to allow multiple mod and multiple admin roles.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Begin updating guild configs to support multiple mod/admin roles&quot;</span><span class="p">)</span>
        <span class="n">all_guild_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">all_guilds</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">guild_id</span><span class="p">,</span> <span class="n">guild_data</span> <span class="ow">in</span> <span class="n">all_guild_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">guild_obj</span> <span class="o">=</span> <span class="n">discord</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">guild_id</span><span class="p">)</span>
            <span class="n">mod_roles</span><span class="p">,</span> <span class="n">admin_roles</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="n">maybe_mod_role_id</span> <span class="o">=</span> <span class="n">guild_data</span><span class="p">[</span><span class="s2">&quot;mod_role&quot;</span><span class="p">]</span>
            <span class="n">maybe_admin_role_id</span> <span class="o">=</span> <span class="n">guild_data</span><span class="p">[</span><span class="s2">&quot;admin_role&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">maybe_mod_role_id</span><span class="p">:</span>
                <span class="n">mod_roles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maybe_mod_role_id</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">guild</span><span class="p">(</span><span class="n">guild_obj</span><span class="p">)</span><span class="o">.</span><span class="n">mod_role</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">mod_roles</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">maybe_admin_role_id</span><span class="p">:</span>
                <span class="n">admin_roles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maybe_admin_role_id</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">guild</span><span class="p">(</span><span class="n">guild_obj</span><span class="p">)</span><span class="o">.</span><span class="n">admin_role</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">admin_roles</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Done updating guild configs to support multiple mod/admin roles&quot;</span><span class="p">)</span>

    <span class="c1"># end Config migrations</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_pre_login</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This should only be run once, prior to logging in to Discord REST API.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_pre_login</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_update_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">description</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_color</span> <span class="o">=</span> <span class="n">discord</span><span class="o">.</span><span class="n">Colour</span><span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">color</span><span class="p">())</span>

        <span class="n">init_global_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">init_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cli_flags</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_owner_id_overwrite</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_owner_id_overwrite</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">owner</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_owner_id_overwrite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">owner_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_owner_id_overwrite</span><span class="p">)</span>

        <span class="n">i18n_locale</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">locale</span><span class="p">()</span>
        <span class="n">i18n</span><span class="o">.</span><span class="n">set_locale</span><span class="p">(</span><span class="n">i18n_locale</span><span class="p">)</span>
        <span class="n">i18n_regional_format</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">regional_format</span><span class="p">()</span>
        <span class="n">i18n</span><span class="o">.</span><span class="n">set_regional_format</span><span class="p">(</span><span class="n">i18n_regional_format</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_pre_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This should only be run once, prior to connecting to Discord gateway.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_cog</span><span class="p">(</span><span class="n">Core</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_cog</span><span class="p">(</span><span class="n">CogManagerUI</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cli_flags</span><span class="o">.</span><span class="n">dev</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_cog</span><span class="p">(</span><span class="n">Dev</span><span class="p">())</span>

        <span class="k">await</span> <span class="n">modlog</span><span class="o">.</span><span class="n">_init</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">bank</span><span class="o">.</span><span class="n">_init</span><span class="p">()</span>

        <span class="n">packages</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="n">last_system_info</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">last_system_info</span><span class="p">()</span>

        <span class="n">ver_info</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">python_version_changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">LIB_PATH</span> <span class="o">=</span> <span class="n">cog_data_path</span><span class="p">(</span><span class="n">raw_name</span><span class="o">=</span><span class="s2">&quot;Downloader&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;lib&quot;</span>
        <span class="k">if</span> <span class="n">ver_info</span> <span class="o">!=</span> <span class="n">last_system_info</span><span class="p">[</span><span class="s2">&quot;python_version&quot;</span><span class="p">]:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">last_system_info</span><span class="o">.</span><span class="n">python_version</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ver_info</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">LIB_PATH</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">LIB_PATH</span><span class="p">))</span>
                <span class="n">LIB_PATH</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
                <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                    <span class="n">send_to_owners_with_prefix_replaced</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span>
                        <span class="s2">&quot;We detected a change in minor Python version&quot;</span>
                        <span class="s2">&quot; and cleared packages in lib folder.</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;The instance was started with no cogs, please load Downloader&quot;</span>
                        <span class="s2">&quot; and use `[p]cog reinstallreqs` to regenerate lib folder.&quot;</span>
                        <span class="s2">&quot; After that, restart the bot to get&quot;</span>
                        <span class="s2">&quot; all of your previously loaded cogs loaded again.&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">python_version_changed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cli_flags</span><span class="o">.</span><span class="n">no_cogs</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">packages</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">packages</span><span class="p">()))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cli_flags</span><span class="o">.</span><span class="n">load_cogs</span><span class="p">:</span>
                <span class="n">packages</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cli_flags</span><span class="o">.</span><span class="n">load_cogs</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cli_flags</span><span class="o">.</span><span class="n">unload_cogs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cli_flags</span><span class="o">.</span><span class="n">unload_cogs</span><span class="p">:</span>
                    <span class="n">packages</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">system_changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">machine</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">machine</span><span class="p">()</span>
        <span class="n">system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">last_system_info</span><span class="p">[</span><span class="s2">&quot;machine&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">last_system_info</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">machine</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">last_system_info</span><span class="p">[</span><span class="s2">&quot;machine&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">machine</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">last_system_info</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">machine</span><span class="p">)</span>
            <span class="n">system_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">last_system_info</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">last_system_info</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">last_system_info</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">system</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">last_system_info</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
            <span class="n">system_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">system_changed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">python_version_changed</span><span class="p">:</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                <span class="n">send_to_owners_with_prefix_replaced</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="s2">&quot;We detected a possible change in machine&#39;s operating system&quot;</span>
                    <span class="s2">&quot; or architecture. You might need to regenerate your lib folder&quot;</span>
                    <span class="s2">&quot; if 3rd-party cogs stop working properly.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;To regenerate lib folder, load Downloader and use `[p]cog reinstallreqs`.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">packages</span><span class="p">:</span>
            <span class="c1"># Load permissions first, for security reasons</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">packages</span><span class="o">.</span><span class="n">move_to_end</span><span class="p">(</span><span class="s2">&quot;permissions&quot;</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading packages...&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">spec</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cog_mgr</span><span class="o">.</span><span class="n">find_cog</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s2">&quot;Failed to load package </span><span class="si">%s</span><span class="s2"> (package was not found in any cog path)&quot;</span><span class="p">,</span>
                            <span class="n">package</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_loaded_package</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
                        <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_extension</span><span class="p">(</span><span class="n">spec</span><span class="p">),</span> <span class="mi">30</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to load package </span><span class="si">%s</span><span class="s2"> (timeout)&quot;</span><span class="p">,</span> <span class="n">package</span><span class="p">)</span>
                    <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to load package </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_loaded_package</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
                    <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">packages</span><span class="p">[</span><span class="n">package</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">packages</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loaded packages: &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">packages</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No packages were loaded.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpc_enabled</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rpc_port</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup_owners</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">team</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_team_features</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">owner_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">team</span><span class="o">.</span><span class="n">members</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_owner_id_overwrite</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">owner_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner_ids</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_NoOwnerSet</span><span class="p">(</span><span class="s2">&quot;Bot doesn&#39;t have any owner set!&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Red.start">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.start">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Overriding start to call _pre_login() before login()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_login</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="c1"># Pre-connect actions are done by setup_hook() which is called at the end of d.py&#39;s login()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span></div>


<div class="viewcode-block" id="Red.setup_hook">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.setup_hook">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">setup_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_owners</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_connect</span><span class="p">()</span></div>


<div class="viewcode-block" id="Red.send_help_for">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.send_help_for">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">send_help_for</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ctx</span><span class="p">:</span> <span class="n">commands</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span>
        <span class="n">help_for</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">commands</span><span class="o">.</span><span class="n">Command</span><span class="p">,</span> <span class="n">commands</span><span class="o">.</span><span class="n">GroupMixin</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">from_help_command</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invokes Red&#39;s helpformatter for a given context and object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_help_formatter</span><span class="o">.</span><span class="n">send_help</span><span class="p">(</span>
            <span class="n">ctx</span><span class="p">,</span> <span class="n">help_for</span><span class="p">,</span> <span class="n">from_help_command</span><span class="o">=</span><span class="n">from_help_command</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Red.embed_requested">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.embed_requested">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">embed_requested</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">channel</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="n">discord</span><span class="o">.</span><span class="n">TextChannel</span><span class="p">,</span>
            <span class="n">discord</span><span class="o">.</span><span class="n">VoiceChannel</span><span class="p">,</span>
            <span class="n">discord</span><span class="o">.</span><span class="n">StageChannel</span><span class="p">,</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span>
            <span class="n">discord</span><span class="o">.</span><span class="n">User</span><span class="p">,</span>
            <span class="n">discord</span><span class="o">.</span><span class="n">Member</span><span class="p">,</span>
            <span class="n">discord</span><span class="o">.</span><span class="n">Thread</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">commands</span><span class="o">.</span><span class="n">Command</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">check_permissions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if an embed is requested for a response.</span>

<span class="sd">        Arguments</span>
<span class="sd">        ---------</span>
<span class="sd">        channel : Union[`discord.TextChannel`, `discord.VoiceChannel`, `discord.StageChannel`, `commands.Context`, `discord.User`, `discord.Member`, `discord.Thread`]</span>
<span class="sd">            The target messageable object to check embed settings for.</span>

<span class="sd">        Keyword Arguments</span>
<span class="sd">        -----------------</span>
<span class="sd">        command : `starbot.core.commands.Command`, optional</span>
<span class="sd">            The command ran.</span>
<span class="sd">            This is auto-filled when ``channel`` is passed with command context.</span>
<span class="sd">        check_permissions : `bool`</span>
<span class="sd">            If ``True``, this method will also check whether the bot can send embeds</span>
<span class="sd">            in the given channel and if it can&#39;t, it will return ``False`` regardless of</span>
<span class="sd">            the bot&#39;s embed settings.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            :code:`True` if an embed is requested</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            When the passed channel is of type `discord.GroupChannel`,</span>
<span class="sd">            `discord.DMChannel`, or `discord.PartialMessageable`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">get_command_setting</span><span class="p">(</span><span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">command</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">custom</span><span class="p">(</span><span class="n">COMMAND_SCOPE</span><span class="p">,</span> <span class="n">command</span><span class="o">.</span><span class="n">qualified_name</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">scope</span><span class="o">.</span><span class="n">embeds</span><span class="p">()</span>

        <span class="c1"># using dpy_commands.Context to keep the Messageable contract in full</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">dpy_commands</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="n">command</span> <span class="o">=</span> <span class="n">command</span> <span class="ow">or</span> <span class="n">channel</span><span class="o">.</span><span class="n">command</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">channel</span><span class="o">.</span><span class="n">author</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">DMChannel</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">channel</span><span class="o">.</span><span class="n">channel</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">channel</span><span class="p">,</span> <span class="p">(</span><span class="n">discord</span><span class="o">.</span><span class="n">GroupChannel</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">DMChannel</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">PartialMessageable</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;You cannot pass a GroupChannel, DMChannel, or PartialMessageable to this method.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">channel</span><span class="p">,</span>
            <span class="p">(</span><span class="n">discord</span><span class="o">.</span><span class="n">TextChannel</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">VoiceChannel</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">StageChannel</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">Thread</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="n">channel_id</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">parent_id</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">Thread</span><span class="p">)</span> <span class="k">else</span> <span class="n">channel</span><span class="o">.</span><span class="n">id</span>

            <span class="k">if</span> <span class="n">check_permissions</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">channel</span><span class="o">.</span><span class="n">permissions_for</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">guild</span><span class="o">.</span><span class="n">me</span><span class="p">)</span><span class="o">.</span><span class="n">embed_links</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">channel_setting</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">channel_from_id</span><span class="p">(</span><span class="n">channel_id</span><span class="p">)</span><span class="o">.</span><span class="n">embeds</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">channel_setting</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">channel_setting</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">command_setting</span> <span class="o">:=</span> <span class="k">await</span> <span class="n">get_command_setting</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">guild</span><span class="o">.</span><span class="n">id</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">command_setting</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">guild_setting</span> <span class="o">:=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">guild</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">guild</span><span class="p">)</span><span class="o">.</span><span class="n">embeds</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">guild_setting</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">channel</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">user_setting</span> <span class="o">:=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">embeds</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">user_setting</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">global_command_setting</span> <span class="o">:=</span> <span class="k">await</span> <span class="n">get_command_setting</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">global_command_setting</span>

        <span class="n">global_setting</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">embeds</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">global_setting</span></div>


<div class="viewcode-block" id="Red.use_buttons">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.use_buttons">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">use_buttons</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines whether the bot owner has enabled use of buttons instead of</span>
<span class="sd">        reactions for basic menus.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">use_buttons</span><span class="p">()</span></div>


<div class="viewcode-block" id="Red.is_owner">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.is_owner">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">is_owner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">Member</span><span class="p">],</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines if the user should be considered a bot owner.</span>

<span class="sd">        This takes into account CLI flags and application ownership.</span>

<span class="sd">        By default,</span>
<span class="sd">        application team members are not considered owners,</span>
<span class="sd">        while individual application owners are.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        user: Union[discord.User, discord.Member]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner_ids</span></div>


<div class="viewcode-block" id="Red.get_invite_url">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.get_invite_url">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_invite_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the invite URL for the bot.</span>

<span class="sd">        Does not check if the invite URL is configured to be public</span>
<span class="sd">        with ``[p]inviteset public``. To check if invites are public,</span>
<span class="sd">        use `Red.is_invite_url_public()`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Invite URL.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scopes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;bot&quot;</span><span class="p">,</span> <span class="s2">&quot;applications.commands&quot;</span><span class="p">)</span>
        <span class="n">perms_int</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">invite_perm</span><span class="p">()</span>
        <span class="n">permissions</span> <span class="o">=</span> <span class="n">discord</span><span class="o">.</span><span class="n">Permissions</span><span class="p">(</span><span class="n">perms_int</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">discord</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">oauth_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application_id</span><span class="p">,</span> <span class="n">permissions</span><span class="o">=</span><span class="n">permissions</span><span class="p">,</span> <span class="n">scopes</span><span class="o">=</span><span class="n">scopes</span><span class="p">)</span></div>


<div class="viewcode-block" id="Red.is_invite_url_public">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.is_invite_url_public">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">is_invite_url_public</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines if invite URL is configured to be public with ``[p]inviteset public``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            :code:`True` if the invite URL is public.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">invite_public</span><span class="p">()</span></div>


<div class="viewcode-block" id="Red.get_install_url">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.get_install_url">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_install_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the install URL for the bot.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Install URL.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;https://discord.com/oauth2/authorize?client_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">application_id</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="Red.is_admin">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.is_admin">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">is_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">member</span><span class="p">:</span> <span class="n">discord</span><span class="o">.</span><span class="n">Member</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks if a member is an admin of their guild.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">snowflake</span> <span class="ow">in</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">guild</span><span class="p">(</span><span class="n">member</span><span class="o">.</span><span class="n">guild</span><span class="p">)</span><span class="o">.</span><span class="n">admin_role</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">member</span><span class="o">.</span><span class="n">get_role</span><span class="p">(</span><span class="n">snowflake</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c1"># someone passed a webhook to this</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Red.is_mod">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.is_mod">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">is_mod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">member</span><span class="p">:</span> <span class="n">discord</span><span class="o">.</span><span class="n">Member</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks if a member is a mod or admin of their guild.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">snowflake</span> <span class="ow">in</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">guild</span><span class="p">(</span><span class="n">member</span><span class="o">.</span><span class="n">guild</span><span class="p">)</span><span class="o">.</span><span class="n">admin_role</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">member</span><span class="o">.</span><span class="n">get_role</span><span class="p">(</span><span class="n">snowflake</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">snowflake</span> <span class="ow">in</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">guild</span><span class="p">(</span><span class="n">member</span><span class="o">.</span><span class="n">guild</span><span class="p">)</span><span class="o">.</span><span class="n">mod_role</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">member</span><span class="o">.</span><span class="n">get_role</span><span class="p">(</span><span class="n">snowflake</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c1"># someone passed a webhook to this</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Red.get_admin_roles">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.get_admin_roles">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_admin_roles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild</span><span class="p">:</span> <span class="n">discord</span><span class="o">.</span><span class="n">Guild</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">Role</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the admin roles for a guild.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">Role</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">snowflake</span> <span class="ow">in</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">guild</span><span class="p">(</span><span class="n">guild</span><span class="p">)</span><span class="o">.</span><span class="n">admin_role</span><span class="p">():</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">guild</span><span class="o">.</span><span class="n">get_role</span><span class="p">(</span><span class="n">snowflake</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="Red.get_mod_roles">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.get_mod_roles">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_mod_roles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild</span><span class="p">:</span> <span class="n">discord</span><span class="o">.</span><span class="n">Guild</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">Role</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the mod roles for a guild.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">Role</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">snowflake</span> <span class="ow">in</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">guild</span><span class="p">(</span><span class="n">guild</span><span class="p">)</span><span class="o">.</span><span class="n">mod_role</span><span class="p">():</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">guild</span><span class="o">.</span><span class="n">get_role</span><span class="p">(</span><span class="n">snowflake</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="Red.get_admin_role_ids">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.get_admin_role_ids">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_admin_role_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the admin role ids for a guild id.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">guild</span><span class="p">(</span><span class="n">discord</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">guild_id</span><span class="p">))</span><span class="o">.</span><span class="n">admin_role</span><span class="p">()</span></div>


<div class="viewcode-block" id="Red.get_mod_role_ids">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.get_mod_role_ids">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_mod_role_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the mod role ids for a guild id.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">guild</span><span class="p">(</span><span class="n">discord</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">guild_id</span><span class="p">))</span><span class="o">.</span><span class="n">mod_role</span><span class="p">()</span></div>


    <span class="nd">@overload</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_shared_api_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="o">...</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_shared_api_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service_name</span><span class="p">:</span> <span class="kc">None</span> <span class="o">=</span> <span class="o">...</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="o">...</span>

<div class="viewcode-block" id="Red.get_shared_api_tokens">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.get_shared_api_tokens">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_shared_api_tokens</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">service_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the shared API tokens for a service, or all of them if no argument specified.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        service_name: str, optional</span>
<span class="sd">            The service to get tokens for. Leave empty to get tokens for all services.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[str, Dict[str, str]] or Dict[str, str]</span>
<span class="sd">            A Mapping of token names to tokens.</span>
<span class="sd">            This mapping exists because some services have multiple tokens.</span>
<span class="sd">            If ``service_name`` is `None`, this method will return</span>
<span class="sd">            a mapping with mappings for all services.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">service_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">custom</span><span class="p">(</span><span class="n">SHARED_API_TOKENS</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">custom</span><span class="p">(</span><span class="n">SHARED_API_TOKENS</span><span class="p">,</span> <span class="n">service_name</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></div>


<div class="viewcode-block" id="Red.set_shared_api_tokens">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.set_shared_api_tokens">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">set_shared_api_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">tokens</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets shared API tokens for a service</span>

<span class="sd">        In most cases, this should not be used. Users should instead be using the</span>
<span class="sd">        ``set api`` command</span>

<span class="sd">        This will not clear existing values not specified.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        service_name: str</span>
<span class="sd">            The service to set tokens for</span>
<span class="sd">        **tokens</span>
<span class="sd">            token_name -&gt; token</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Setting the api_key for youtube from a value in a variable ``my_key``</span>

<span class="sd">        &gt;&gt;&gt; await ctx.bot.set_shared_api_tokens(&quot;youtube&quot;, api_key=my_key)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">custom</span><span class="p">(</span><span class="n">SHARED_API_TOKENS</span><span class="p">,</span> <span class="n">service_name</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">as</span> <span class="n">group</span><span class="p">:</span>
            <span class="n">group</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="s2">&quot;red_api_tokens_update&quot;</span><span class="p">,</span> <span class="n">service_name</span><span class="p">,</span> <span class="n">MappingProxyType</span><span class="p">(</span><span class="n">group</span><span class="p">))</span></div>


<div class="viewcode-block" id="Red.remove_shared_api_tokens">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.remove_shared_api_tokens">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">remove_shared_api_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">token_names</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes shared API tokens</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        service_name: str</span>
<span class="sd">            The service to remove tokens for</span>
<span class="sd">        *token_names: str</span>
<span class="sd">            The name of each token to be removed</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Removing the api_key for youtube</span>

<span class="sd">        &gt;&gt;&gt; await ctx.bot.remove_shared_api_tokens(&quot;youtube&quot;, &quot;api_key&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">custom</span><span class="p">(</span><span class="n">SHARED_API_TOKENS</span><span class="p">,</span> <span class="n">service_name</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">as</span> <span class="n">group</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">token_names</span><span class="p">:</span>
                <span class="n">group</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="s2">&quot;red_api_tokens_update&quot;</span><span class="p">,</span> <span class="n">service_name</span><span class="p">,</span> <span class="n">MappingProxyType</span><span class="p">(</span><span class="n">group</span><span class="p">))</span></div>


<div class="viewcode-block" id="Red.remove_shared_api_services">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.remove_shared_api_services">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">remove_shared_api_services</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">service_names</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes shared API services, as well as keys and tokens associated with them.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        *service_names: str</span>
<span class="sd">            The services to remove.</span>

<span class="sd">        Examples</span>
<span class="sd">        ----------</span>
<span class="sd">        Removing the youtube service</span>

<span class="sd">        &gt;&gt;&gt; await ctx.bot.remove_shared_api_services(&quot;youtube&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">custom</span><span class="p">(</span><span class="n">SHARED_API_TOKENS</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">as</span> <span class="n">group</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">service_names</span><span class="p">:</span>
                <span class="n">group</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># dispatch needs to happen *after* it actually updates</span>
        <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">service_names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="s2">&quot;red_api_tokens_update&quot;</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">MappingProxyType</span><span class="p">({}))</span></div>


    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">commands</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">cls</span><span class="p">)</span>

<div class="viewcode-block" id="Red.process_commands">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.process_commands">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">process_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">discord</span><span class="o">.</span><span class="n">Message</span><span class="p">,</span> <span class="o">/</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Same as base method, but dispatches an additional event for cogs</span>
<span class="sd">        which want to handle normal messages differently to command</span>
<span class="sd">        messages,  without the overhead of additional get_context calls</span>
<span class="sd">        per cog.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">bot</span><span class="p">:</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

            <span class="c1"># The licenseinfo command must always be available, even in a slash only bot.</span>
            <span class="c1"># To get around not having the message content intent, a mention prefix</span>
            <span class="c1"># will always work for it.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ctx</span><span class="o">.</span><span class="n">valid</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;@</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&gt; &quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&lt;@!</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&gt; &quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                        <span class="n">ctx</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">undo</span><span class="p">()</span>
                        <span class="n">ctx</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">skip_string</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                        <span class="n">invoker</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">get_word</span><span class="p">()</span>
                        <span class="n">command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_commands</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">invoker</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">commands</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">_AlwaysAvailableMixin</span><span class="p">):</span>
                            <span class="n">ctx</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span>
                            <span class="n">ctx</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">m</span>
                        <span class="k">break</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">invoked_with</span>
                <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">PartialMessageable</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">message</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">discord</span><span class="o">.</span><span class="n">ChannelType</span><span class="o">.</span><span class="n">private</span>
            <span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Discarded a command message (ID: </span><span class="si">%s</span><span class="s2">) with PartialMessageable channel: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ctx</span><span class="o">.</span><span class="n">valid</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="s2">&quot;message_without_command&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span></div>


<div class="viewcode-block" id="Red.list_packages">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.list_packages">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">list_packages</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lists packages present in the cogs folder&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s2">&quot;cogs&quot;</span><span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span> <span class="nf">save_packages_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packages</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">packages</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">add_loaded_package</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">packages</span><span class="p">()</span> <span class="k">as</span> <span class="n">curr_pkgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pkg_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">curr_pkgs</span><span class="p">:</span>
                <span class="n">curr_pkgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">remove_loaded_package</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">packages</span><span class="p">()</span> <span class="k">as</span> <span class="n">curr_pkgs</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">pkg_name</span> <span class="ow">in</span> <span class="n">curr_pkgs</span><span class="p">:</span>
                <span class="n">curr_pkgs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>

<div class="viewcode-block" id="Red.load_extension">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.load_extension">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">load_extension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">ModuleSpec</span><span class="p">):</span>
        <span class="c1"># NB: this completely bypasses `discord.ext.commands.Bot._load_from_module_spec`</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">PackageAlreadyLoaded</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="n">lib</span> <span class="o">=</span> <span class="n">module_from_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">lib</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">exec_module</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">raise</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="s2">&quot;setup&quot;</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">lib</span>
            <span class="k">raise</span> <span class="n">discord</span><span class="o">.</span><span class="n">ClientException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extension </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not have a setup function.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">lib</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">red_check_enabled</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_module_references</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_module_finalizers</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_BotBase__extensions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">lib</span></div>


<div class="viewcode-block" id="Red.remove_cog">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.remove_cog">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">remove_cog</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cogname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">guild</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Snowflake</span><span class="p">]</span> <span class="o">=</span> <span class="n">discord</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">MISSING</span><span class="p">,</span>
        <span class="n">guilds</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Snowflake</span><span class="p">]</span> <span class="o">=</span> <span class="n">discord</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">MISSING</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">commands</span><span class="o">.</span><span class="n">Cog</span><span class="p">]:</span>
        <span class="n">cog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cog</span><span class="p">(</span><span class="n">cogname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmro</span><span class="p">(</span><span class="n">cog</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hook</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cog</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">__permissions_hook&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remove_permissions_hook</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span>

        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">remove_cog</span><span class="p">(</span><span class="n">cogname</span><span class="p">,</span> <span class="n">guild</span><span class="o">=</span><span class="n">guild</span><span class="p">,</span> <span class="n">guilds</span><span class="o">=</span><span class="n">guilds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="s2">&quot;cog_remove&quot;</span><span class="p">,</span> <span class="n">cog</span><span class="p">)</span>

        <span class="n">cog</span><span class="o">.</span><span class="n">requires</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">meth</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpc_handlers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">cogname</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unregister_rpc_handler</span><span class="p">(</span><span class="n">meth</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cog</span></div>


<div class="viewcode-block" id="Red.enable_app_command">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.enable_app_command">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">enable_app_command</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">command_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">command_type</span><span class="p">:</span> <span class="n">discord</span><span class="o">.</span><span class="n">AppCommandType</span> <span class="o">=</span> <span class="n">discord</span><span class="o">.</span><span class="n">AppCommandType</span><span class="o">.</span><span class="n">chat_input</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mark an application command as being enabled.</span>
<span class="sd">        Enabled commands are able to be added to the bot&#39;s tree, are able to be synced, and can be invoked.</span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        CommandLimitReached</span>
<span class="sd">            Raised when attempting to enable a command that would exceed the command limit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">command_type</span> <span class="ow">is</span> <span class="n">discord</span><span class="o">.</span><span class="n">AppCommandType</span><span class="o">.</span><span class="n">chat_input</span><span class="p">:</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">enabled_slash_commands</span><span class="p">()</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="k">elif</span> <span class="n">command_type</span> <span class="ow">is</span> <span class="n">discord</span><span class="o">.</span><span class="n">AppCommandType</span><span class="o">.</span><span class="n">message</span><span class="p">:</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">enabled_message_commands</span><span class="p">()</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">elif</span> <span class="n">command_type</span> <span class="ow">is</span> <span class="n">discord</span><span class="o">.</span><span class="n">AppCommandType</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">enabled_user_commands</span><span class="p">()</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;command type must be one of chat_input, message, user&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">cfg</span> <span class="k">as</span> <span class="n">curr_commands</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">curr_commands</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">app_commands</span><span class="o">.</span><span class="n">CommandLimitReached</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">command_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">command_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">curr_commands</span><span class="p">:</span>
                <span class="n">curr_commands</span><span class="p">[</span><span class="n">command_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Red.disable_app_command">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.disable_app_command">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">disable_app_command</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">command_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">command_type</span><span class="p">:</span> <span class="n">discord</span><span class="o">.</span><span class="n">AppCommandType</span> <span class="o">=</span> <span class="n">discord</span><span class="o">.</span><span class="n">AppCommandType</span><span class="o">.</span><span class="n">chat_input</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mark an application command as being disabled.</span>
<span class="sd">        Disabled commands are not added to the bot&#39;s tree, are not able to be synced, and cannot be invoked.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">command_type</span> <span class="ow">is</span> <span class="n">discord</span><span class="o">.</span><span class="n">AppCommandType</span><span class="o">.</span><span class="n">chat_input</span><span class="p">:</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">enabled_slash_commands</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">command_type</span> <span class="ow">is</span> <span class="n">discord</span><span class="o">.</span><span class="n">AppCommandType</span><span class="o">.</span><span class="n">message</span><span class="p">:</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">enabled_message_commands</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">command_type</span> <span class="ow">is</span> <span class="n">discord</span><span class="o">.</span><span class="n">AppCommandType</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">enabled_user_commands</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;command type must be one of chat_input, message, user&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">cfg</span> <span class="k">as</span> <span class="n">curr_commands</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">command_name</span> <span class="ow">in</span> <span class="n">curr_commands</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">curr_commands</span><span class="p">[</span><span class="n">command_name</span><span class="p">]</span></div>


<div class="viewcode-block" id="Red.list_enabled_app_commands">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.list_enabled_app_commands">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">list_enabled_app_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List the currently enabled application command names.&quot;&quot;&quot;</span>
        <span class="n">curr_slash_commands</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">enabled_slash_commands</span><span class="p">()</span>
        <span class="n">curr_message_commands</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">enabled_message_commands</span><span class="p">()</span>
        <span class="n">curr_user_commands</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">enabled_user_commands</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;slash&quot;</span><span class="p">:</span> <span class="n">curr_slash_commands</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">curr_message_commands</span><span class="p">,</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">curr_user_commands</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="Red.is_automod_immune">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.is_automod_immune">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">is_automod_immune</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">to_check</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">Message</span><span class="p">,</span> <span class="n">commands</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">Role</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the user, message, context, or role should be considered immune from automated</span>
<span class="sd">        moderation actions.</span>

<span class="sd">        Bot users are considered immune.</span>

<span class="sd">        This will return ``False`` in direct messages.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        to_check : `discord.Message` or `commands.Context` or `discord.abc.User` or `discord.Role`</span>
<span class="sd">            Something to check if it would be immune</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            ``True`` if immune</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">guild</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">to_check</span><span class="p">,</span> <span class="s2">&quot;guild&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">guild</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_check</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">Role</span><span class="p">):</span>
            <span class="n">ids_to_check</span> <span class="o">=</span> <span class="p">{</span><span class="n">to_check</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">author</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">to_check</span><span class="p">,</span> <span class="s2">&quot;author&quot;</span><span class="p">,</span> <span class="n">to_check</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">author</span><span class="o">.</span><span class="n">bot</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="n">ids_to_check</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ids_to_check</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">author</span><span class="o">.</span><span class="n">roles</span><span class="p">}</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="c1"># cheaper than isinstance(author, discord.User)</span>
                <span class="k">pass</span>
            <span class="n">ids_to_check</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">author</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="n">immune_ids</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">guild</span><span class="p">(</span><span class="n">guild</span><span class="p">)</span><span class="o">.</span><span class="n">autoimmune_ids</span><span class="p">()</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">ids_to_check</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">immune_ids</span><span class="p">)</span></div>


<div class="viewcode-block" id="Red.send_filtered">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.send_filtered">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">send_filtered</span><span class="p">(</span>
        <span class="n">destination</span><span class="p">:</span> <span class="n">discord</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Messageable</span><span class="p">,</span>
        <span class="n">filter_mass_mentions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">filter_invite_links</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">filter_all_links</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a convenience wrapper around</span>

<span class="sd">        discord.abc.Messageable.send</span>

<span class="sd">        It takes the destination you&#39;d like to send to, which filters to apply</span>
<span class="sd">        (defaults on mass mentions, and invite links) and any other parameters</span>
<span class="sd">        normally accepted by destination.send</span>

<span class="sd">        This should realistically only be used for responding using user provided</span>
<span class="sd">        input. (unfortunately, including usernames)</span>
<span class="sd">        Manually crafted messages which don&#39;t take any user input have no need of this</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        discord.Message</span>
<span class="sd">            The message that was sent.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">content</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filter_mass_mentions</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">common_filters</span><span class="o">.</span><span class="n">filter_mass_mentions</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filter_invite_links</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">common_filters</span><span class="o">.</span><span class="n">filter_invites</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filter_all_links</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">common_filters</span><span class="o">.</span><span class="n">filter_urls</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="k">await</span> <span class="n">destination</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Red.add_cog">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.add_cog">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">add_cog</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cog</span><span class="p">:</span> <span class="n">commands</span><span class="o">.</span><span class="n">Cog</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">override</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">guild</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Snowflake</span><span class="p">]</span> <span class="o">=</span> <span class="n">discord</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">MISSING</span><span class="p">,</span>
        <span class="n">guilds</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Snowflake</span><span class="p">]</span> <span class="o">=</span> <span class="n">discord</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">MISSING</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cog</span><span class="p">,</span> <span class="n">commands</span><span class="o">.</span><span class="n">Cog</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">cog</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> cog in the </span><span class="si">{</span><span class="n">cog</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2"> package does &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;not inherit from the commands.Cog base class. The cog author must update &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;the cog to adhere to this requirement.&quot;</span>
            <span class="p">)</span>
        <span class="n">cog_name</span> <span class="o">=</span> <span class="n">cog</span><span class="o">.</span><span class="n">__cog_name__</span>
        <span class="k">if</span> <span class="n">cog_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cogs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">override</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">discord</span><span class="o">.</span><span class="n">ClientException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cog named </span><span class="si">{</span><span class="n">cog_name</span><span class="si">!r}</span><span class="s2"> already loaded&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_cog</span><span class="p">(</span><span class="n">cog_name</span><span class="p">,</span> <span class="n">guild</span><span class="o">=</span><span class="n">guild</span><span class="p">,</span> <span class="n">guilds</span><span class="o">=</span><span class="n">guilds</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cog</span><span class="p">,</span> <span class="s2">&quot;requires&quot;</span><span class="p">):</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">Cog</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">cog</span><span class="p">)</span>

        <span class="n">added_hooks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmro</span><span class="p">(</span><span class="n">cog</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hook</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cog</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">__permissions_hook&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_permissions_hook</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span>
                    <span class="n">added_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span>

            <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_cog</span><span class="p">(</span><span class="n">cog</span><span class="p">,</span> <span class="n">guild</span><span class="o">=</span><span class="n">guild</span><span class="p">,</span> <span class="n">guilds</span><span class="o">=</span><span class="n">guilds</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="s2">&quot;cog_add&quot;</span><span class="p">,</span> <span class="n">cog</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;permissions&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span><span class="p">:</span>
                <span class="n">cog</span><span class="o">.</span><span class="n">requires</span><span class="o">.</span><span class="n">ready_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="n">added_hooks</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">remove_permissions_hook</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># This shouldn&#39;t be possible</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                        <span class="s2">&quot;A hook got extremely screwed up, &quot;</span>
                        <span class="s2">&quot;and could not be removed properly during another error in cog load.&quot;</span>
                    <span class="p">)</span>
            <span class="k">del</span> <span class="n">cog</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="Red.add_command">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.add_command">[docs]</a>
    <span class="k">def</span> <span class="nf">add_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">commands</span><span class="o">.</span><span class="n">Command</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">commands</span><span class="o">.</span><span class="n">Command</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Commands must be instances of `starbot.core.commands.Command`&quot;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

        <span class="n">permissions_not_loaded</span> <span class="o">=</span> <span class="s2">&quot;permissions&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="s2">&quot;command_add&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">permissions_not_loaded</span><span class="p">:</span>
            <span class="n">command</span><span class="o">.</span><span class="n">requires</span><span class="o">.</span><span class="n">ready_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">commands</span><span class="o">.</span><span class="n">Group</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">subcommand</span> <span class="ow">in</span> <span class="n">command</span><span class="o">.</span><span class="n">walk_commands</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="s2">&quot;command_add&quot;</span><span class="p">,</span> <span class="n">subcommand</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">permissions_not_loaded</span><span class="p">:</span>
                    <span class="n">subcommand</span><span class="o">.</span><span class="n">requires</span><span class="o">.</span><span class="n">ready_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="p">(</span><span class="n">commands</span><span class="o">.</span><span class="n">HybridCommand</span><span class="p">,</span> <span class="n">commands</span><span class="o">.</span><span class="n">HybridGroup</span><span class="p">)):</span>
            <span class="n">command</span><span class="o">.</span><span class="n">app_command</span><span class="o">.</span><span class="n">extras</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">extras</span></div>


<div class="viewcode-block" id="Red.remove_command">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.remove_command">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">commands</span><span class="o">.</span><span class="n">Command</span><span class="p">]:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">remove_command</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">command</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">command</span><span class="o">.</span><span class="n">requires</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">commands</span><span class="o">.</span><span class="n">Group</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">subcommand</span> <span class="ow">in</span> <span class="n">command</span><span class="o">.</span><span class="n">walk_commands</span><span class="p">():</span>
                <span class="n">subcommand</span><span class="o">.</span><span class="n">requires</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">command</span></div>


    <span class="k">def</span> <span class="nf">readd_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">commands</span><span class="o">.</span><span class="n">Command</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_command</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

<div class="viewcode-block" id="Red.hybrid_command">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.hybrid_command">[docs]</a>
    <span class="k">def</span> <span class="nf">hybrid_command</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">app_commands</span><span class="o">.</span><span class="n">locale_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">discord</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">MISSING</span><span class="p">,</span>
        <span class="n">with_app_command</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">CommandCallback</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">ContextT</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">_T</span><span class="p">]],</span> <span class="n">commands</span><span class="o">.</span><span class="n">HybridCommand</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">_T</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A shortcut decorator that invokes :func:`~starbot.core.commands.hybrid_command` and adds it to</span>
<span class="sd">        the internal command list via :meth:`add_command`.</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        Callable[..., :class:`HybridCommand`]</span>
<span class="sd">            A decorator that converts the provided method into a Command, adds it to the bot, then returns it.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">CommandCallback</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">ContextT</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">_T</span><span class="p">]):</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">commands</span><span class="o">.</span><span class="n">hybrid_command</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">with_app_command</span><span class="o">=</span><span class="n">with_app_command</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)(</span><span class="n">func</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">return</span> <span class="n">decorator</span></div>


<div class="viewcode-block" id="Red.hybrid_group">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.hybrid_group">[docs]</a>
    <span class="k">def</span> <span class="nf">hybrid_group</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">app_commands</span><span class="o">.</span><span class="n">locale_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">discord</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">MISSING</span><span class="p">,</span>
        <span class="n">with_app_command</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">CommandCallback</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">ContextT</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">_T</span><span class="p">]],</span> <span class="n">commands</span><span class="o">.</span><span class="n">HybridGroup</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">_T</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A shortcut decorator that invokes :func:`~starbot.core.commands.hybrid_group` and adds it to</span>
<span class="sd">        the internal command list via :meth:`add_command`.</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        Callable[..., :class:`HybridGroup`]</span>
<span class="sd">            A decorator that converts the provided method into a Group, adds it to the bot, then returns it.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">CommandCallback</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">ContextT</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">_T</span><span class="p">]):</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">commands</span><span class="o">.</span><span class="n">hybrid_group</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">with_app_command</span><span class="o">=</span><span class="n">with_app_command</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)(</span><span class="n">func</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">return</span> <span class="n">decorator</span></div>


<div class="viewcode-block" id="Red.clear_permission_rules">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.clear_permission_rules">[docs]</a>
    <span class="k">def</span> <span class="nf">clear_permission_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guild_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear all permission overrides in a scope.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        guild_id : Optional[int]</span>
<span class="sd">            The guild ID to wipe permission overrides for. If</span>
<span class="sd">            ``None``, this will clear all global rules and leave all</span>
<span class="sd">            guild rules untouched.</span>

<span class="sd">        **kwargs</span>
<span class="sd">            Keyword arguments to be passed to each required call of</span>
<span class="sd">            ``commands.Requires.clear_all_rules``</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cog</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cogs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">cog</span><span class="o">.</span><span class="n">requires</span><span class="o">.</span><span class="n">clear_all_rules</span><span class="p">(</span><span class="n">guild_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">walk_commands</span><span class="p">():</span>
            <span class="n">command</span><span class="o">.</span><span class="n">requires</span><span class="o">.</span><span class="n">clear_all_rules</span><span class="p">(</span><span class="n">guild_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Red.add_permissions_hook">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.add_permissions_hook">[docs]</a>
    <span class="k">def</span> <span class="nf">add_permissions_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook</span><span class="p">:</span> <span class="n">commands</span><span class="o">.</span><span class="n">CheckPredicate</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a permissions hook.</span>

<span class="sd">        Permissions hooks are check predicates which are called before</span>
<span class="sd">        calling `Requires.verify`, and they can optionally return an</span>
<span class="sd">        override: ``True`` to allow, ``False`` to deny, and ``None`` to</span>
<span class="sd">        default to normal behaviour.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hook</span>
<span class="sd">            A command check predicate which returns ``True``, ``False``</span>
<span class="sd">            or ``None``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_permissions_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span></div>


<div class="viewcode-block" id="Red.remove_permissions_hook">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.remove_permissions_hook">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_permissions_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook</span><span class="p">:</span> <span class="n">commands</span><span class="o">.</span><span class="n">CheckPredicate</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove a permissions hook.</span>

<span class="sd">        Parameters are the same as those in `add_permissions_hook`.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the permissions hook has not been added.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_permissions_hooks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span></div>


<div class="viewcode-block" id="Red.verify_permissions_hooks">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.verify_permissions_hooks">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">verify_permissions_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">commands</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run permissions hooks.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ctx : commands.Context</span>
<span class="sd">            The context for the command being invoked.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Optional[bool]</span>
<span class="sd">            ``False`` if any hooks returned ``False``, ``True`` if any</span>
<span class="sd">            hooks return ``True`` and none returned ``False``, ``None``</span>
<span class="sd">            otherwise.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hook_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permissions_hooks</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">discord</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">maybe_coroutine</span><span class="p">(</span><span class="n">hook</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hook_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hook_results</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">hook_results</span><span class="p">):</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">permission_state</span> <span class="o">=</span> <span class="n">commands</span><span class="o">.</span><span class="n">PermState</span><span class="o">.</span><span class="n">ALLOWED_BY_HOOK</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">permission_state</span> <span class="o">=</span> <span class="n">commands</span><span class="o">.</span><span class="n">PermState</span><span class="o">.</span><span class="n">DENIED_BY_HOOK</span>
                <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Red.get_owner_notification_destinations">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.get_owner_notification_destinations">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_owner_notification_destinations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span>
        <span class="n">Union</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">TextChannel</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">VoiceChannel</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">StageChannel</span><span class="p">,</span> <span class="n">discord</span><span class="o">.</span><span class="n">User</span><span class="p">]</span>
    <span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the users and channels to send to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_until_red_ready</span><span class="p">()</span>
        <span class="n">destinations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">opt_outs</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">owner_opt_out_list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opt_outs</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">bot</span><span class="p">:</span>  <span class="c1"># user.bot is possible with flags and teams</span>
                    <span class="n">destinations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Owner with ID </span><span class="si">%s</span><span class="s2"> is missing in user cache,&quot;</span>
                        <span class="s2">&quot; ignoring owner notification destination.&quot;</span><span class="p">,</span>
                        <span class="n">user_id</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="n">channel_ids</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">extra_owner_destinations</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">channel_id</span> <span class="ow">in</span> <span class="n">channel_ids</span><span class="p">:</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_channel</span><span class="p">(</span><span class="n">channel_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">channel</span><span class="p">:</span>
                <span class="n">destinations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Channel with ID </span><span class="si">%s</span><span class="s2"> is not available,&quot;</span>
                    <span class="s2">&quot; ignoring owner notification destination.&quot;</span><span class="p">,</span>
                    <span class="n">channel_id</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">destinations</span></div>


<div class="viewcode-block" id="Red.send_to_owners">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.send_to_owners">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">send_to_owners</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This sends something to all owners and their configured extra destinations.</span>

<span class="sd">        This takes the same arguments as discord.abc.Messageable.send</span>

<span class="sd">        This logs failing sends</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">destinations</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_owner_notification_destinations</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">wrapped_send</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">location</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_exc</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;I could not send an owner notification to </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
                    <span class="n">location</span><span class="p">,</span>
                    <span class="n">location</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">exc_info</span><span class="o">=</span><span class="n">_exc</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">sends</span> <span class="o">=</span> <span class="p">[</span><span class="n">wrapped_send</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">destinations</span><span class="p">]</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">sends</span><span class="p">)</span></div>


<div class="viewcode-block" id="Red.wait_until_red_ready">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.wait_until_red_ready">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">wait_until_red_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait until our post connection startup is done.&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_red_ready</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div>


    <span class="k">async</span> <span class="k">def</span> <span class="nf">_delete_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">commands</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Currently used for:</span>
<span class="sd">          * delete delay</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">guild</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">guild</span>
        <span class="k">if</span> <span class="n">guild</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">message</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">guild</span><span class="p">(</span><span class="n">guild</span><span class="p">)</span><span class="o">.</span><span class="n">delete_delay</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">delay</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">_delete_helper</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="n">discord</span><span class="o">.</span><span class="n">HTTPException</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">m</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Deleted command msg </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">_delete_helper</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<div class="viewcode-block" id="Red.close">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.close">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Logs out of Discord and closes all connections.&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">_drivers</span><span class="o">.</span><span class="n">get_driver_class</span><span class="p">()</span><span class="o">.</span><span class="n">teardown</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpc_enabled</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="Red.shutdown">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.shutdown">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">restart</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gracefully quit Red.</span>

<span class="sd">        The program will exit with code :code:`0` by default.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        restart : bool</span>
<span class="sd">            If :code:`True`, the program will exit with code :code:`26`. If the</span>
<span class="sd">            launcher sees this, it will attempt to restart the bot.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">restart</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_mode</span> <span class="o">=</span> <span class="n">ExitCodes</span><span class="o">.</span><span class="n">SHUTDOWN</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_mode</span> <span class="o">=</span> <span class="n">ExitCodes</span><span class="o">.</span><span class="n">RESTART</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_mode</span><span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span> <span class="nf">_core_data_deletion</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">requester</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;discord_deleted_user&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;user_strict&quot;</span><span class="p">],</span>
        <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">requester</span> <span class="o">!=</span> <span class="s2">&quot;discord_deleted_user&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">user_from_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">all_guilds</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">all_guilds</span><span class="p">()</span>

        <span class="k">async</span> <span class="k">for</span> <span class="n">guild_id</span><span class="p">,</span> <span class="n">guild_data</span> <span class="ow">in</span> <span class="n">AsyncIter</span><span class="p">(</span><span class="n">all_guilds</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">steps</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">guild_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;autoimmune_ids&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">guild_from_id</span><span class="p">(</span><span class="n">guild_id</span><span class="p">)</span><span class="o">.</span><span class="n">autoimmune_ids</span><span class="p">()</span> <span class="k">as</span> <span class="n">ids</span><span class="p">:</span>
                    <span class="c1"># prevent a racy crash here without locking</span>
                    <span class="c1"># up the vals in all guilds first</span>
                    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                        <span class="n">ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_whiteblacklist_cache</span><span class="o">.</span><span class="n">discord_deleted_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

<div class="viewcode-block" id="Red.handle_data_deletion_request">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.handle_data_deletion_request">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_data_deletion_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">requester</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;discord_deleted_user&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;user_strict&quot;</span><span class="p">],</span>
        <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataDeletionResults</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This tells each cog and extension, as well as any APIs in Red</span>
<span class="sd">        to go delete data</span>

<span class="sd">        Calling this should be limited to interfaces designed for it.</span>

<span class="sd">        See ``starbot.core.commands.Cog.delete_data_for_user``</span>
<span class="sd">        for details about the parameters and intent.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        requester</span>
<span class="sd">        user_id</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataDeletionResults</span>
<span class="sd">            A named tuple ``(failed_modules, failed_cogs, unhandled)``</span>
<span class="sd">            containing lists with names of failed modules, failed cogs,</span>
<span class="sd">            and cogs that didn&#39;t handle data deletion request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_until_red_ready</span><span class="p">()</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deletion_requests</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">())</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_data_deletion_request</span><span class="p">(</span><span class="n">requester</span><span class="o">=</span><span class="n">requester</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span> <span class="nf">_handle_data_deletion_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">requester</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;discord_deleted_user&quot;</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;user_strict&quot;</span><span class="p">],</span>
        <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataDeletionResults</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Actual interface for the above.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        requester</span>
<span class="sd">        user_id</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataDeletionResults</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">extension_handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">extension_name</span><span class="p">:</span> <span class="n">handler</span>
            <span class="k">for</span> <span class="n">extension_name</span><span class="p">,</span> <span class="n">extension</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">handler</span> <span class="o">:=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">extension</span><span class="p">,</span> <span class="s2">&quot;red_delete_data_for_user&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="p">}</span>

        <span class="n">cog_handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">cog_qualname</span><span class="p">:</span> <span class="n">cog</span><span class="o">.</span><span class="n">red_delete_data_for_user</span> <span class="k">for</span> <span class="n">cog_qualname</span><span class="p">,</span> <span class="n">cog</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cogs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="n">special_handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Red Core Modlog API&quot;</span><span class="p">:</span> <span class="n">modlog</span><span class="o">.</span><span class="n">_process_data_deletion</span><span class="p">,</span>
            <span class="s2">&quot;Red Core Bank API&quot;</span><span class="p">:</span> <span class="n">bank</span><span class="o">.</span><span class="n">_process_data_deletion</span><span class="p">,</span>
            <span class="s2">&quot;Red Core Bot Data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_core_data_deletion</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">failures</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;extension&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;cog&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;unhandled&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">stype</span><span class="p">,</span> <span class="n">sname</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">func</span><span class="p">(</span><span class="n">requester</span><span class="o">=</span><span class="n">requester</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">commands</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">RedUnhandledAPI</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stype</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">sname</span><span class="si">}</span><span class="s2"> did not handle data deletion &quot;</span><span class="p">)</span>
                <span class="n">failures</span><span class="p">[</span><span class="s2">&quot;unhandled&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sname</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stype</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">sname</span><span class="si">}</span><span class="s2"> errored when handling data deletion &quot;</span><span class="p">)</span>
                <span class="n">failures</span><span class="p">[</span><span class="n">stype</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sname</span><span class="p">)</span>

        <span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="o">*</span><span class="p">(</span><span class="n">wrapper</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="s2">&quot;extension&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">coro</span> <span class="ow">in</span> <span class="n">extension_handlers</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
            <span class="o">*</span><span class="p">(</span><span class="n">wrapper</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="s2">&quot;cog&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">coro</span> <span class="ow">in</span> <span class="n">cog_handlers</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
            <span class="o">*</span><span class="p">(</span><span class="n">wrapper</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="s2">&quot;extension&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">coro</span> <span class="ow">in</span> <span class="n">special_handlers</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
        <span class="p">]</span>

        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">handlers</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">DataDeletionResults</span><span class="p">(</span>
            <span class="n">failed_modules</span><span class="o">=</span><span class="n">failures</span><span class="p">[</span><span class="s2">&quot;extension&quot;</span><span class="p">],</span>
            <span class="n">failed_cogs</span><span class="o">=</span><span class="n">failures</span><span class="p">[</span><span class="s2">&quot;cog&quot;</span><span class="p">],</span>
            <span class="n">unhandled</span><span class="o">=</span><span class="n">failures</span><span class="p">[</span><span class="s2">&quot;unhandled&quot;</span><span class="p">],</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Red.send_interactive">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.send_interactive">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">send_interactive</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">channel</span><span class="p">:</span> <span class="n">discord</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Messageable</span><span class="p">,</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">User</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">box_lang</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
        <span class="n">join_character</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">discord</span><span class="o">.</span><span class="n">Message</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send multiple messages interactively.</span>

<span class="sd">        The user will be prompted for whether or not they would like to view</span>
<span class="sd">        the next message, one at a time. They will also be notified of how</span>
<span class="sd">        many messages are remaining on each prompt.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        channel : discord.abc.Messageable</span>
<span class="sd">            The channel to send the messages to.</span>
<span class="sd">        messages : `iterable` of `str`</span>
<span class="sd">            The messages to send.</span>
<span class="sd">        user : discord.User</span>
<span class="sd">            The user that can respond to the prompt.</span>
<span class="sd">            When this is ``None``, any user can respond.</span>
<span class="sd">        box_lang : Optional[str]</span>
<span class="sd">            If specified, each message will be contained within a code block of</span>
<span class="sd">            this language.</span>
<span class="sd">        timeout : int</span>
<span class="sd">            How long the user has to respond to the prompt before it times out.</span>
<span class="sd">            After timing out, the bot deletes its prompt message.</span>
<span class="sd">        join_character : str</span>
<span class="sd">            The character used to join all the messages when the file output</span>
<span class="sd">            is selected.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[discord.Message]</span>
<span class="sd">            A list of sent messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># using dpy_commands.Context to keep the Messageable contract in full</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">dpy_commands</span><span class="o">.</span><span class="n">Context</span><span class="p">):</span>
            <span class="c1"># this is only necessary to ensure that `channel.delete_messages()` works</span>
            <span class="c1"># when `ctx.channel` has that method</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">channel</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">box_lang</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="n">channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="n">channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">box</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="n">box_lang</span><span class="p">))</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">n_remaining</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span> <span class="o">-</span> <span class="n">idx</span>
            <span class="k">if</span> <span class="n">n_remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n_remaining</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">prompt_text</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;There is still one message remaining. Type </span><span class="si">{command_1}</span><span class="s2"> to continue&quot;</span>
                        <span class="s2">&quot; or </span><span class="si">{command_2}</span><span class="s2"> to upload all contents as a file.&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prompt_text</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;There are still </span><span class="si">{count}</span><span class="s2"> messages remaining. Type </span><span class="si">{command_1}</span><span class="s2"> to continue&quot;</span>
                        <span class="s2">&quot; or </span><span class="si">{command_2}</span><span class="s2"> to upload all contents as a file.&quot;</span>
                    <span class="p">)</span>
                <span class="n">query</span> <span class="o">=</span> <span class="k">await</span> <span class="n">channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                    <span class="n">prompt_text</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="n">n_remaining</span><span class="p">,</span> <span class="n">command_1</span><span class="o">=</span><span class="s2">&quot;`more`&quot;</span><span class="p">,</span> <span class="n">command_2</span><span class="o">=</span><span class="s2">&quot;`file`&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">MessagePredicate</span><span class="o">.</span><span class="n">lower_contained_in</span><span class="p">(</span>
                    <span class="p">(</span><span class="s2">&quot;more&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">),</span> <span class="n">channel</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">,</span>
                        <span class="n">check</span><span class="o">=</span><span class="n">pred</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="n">discord</span><span class="o">.</span><span class="n">HTTPException</span><span class="p">):</span>
                        <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">channel</span><span class="o">.</span><span class="n">delete_messages</span><span class="p">((</span><span class="n">query</span><span class="p">,</span> <span class="n">resp</span><span class="p">))</span>
                    <span class="k">except</span> <span class="p">(</span><span class="n">discord</span><span class="o">.</span><span class="n">HTTPException</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                        <span class="c1"># In case the bot can&#39;t delete other users&#39; messages,</span>
                        <span class="c1"># or is not a bot account</span>
                        <span class="c1"># or channel is a DM</span>
                        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="n">discord</span><span class="o">.</span><span class="n">HTTPException</span><span class="p">):</span>
                            <span class="k">await</span> <span class="n">query</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">pred</span><span class="o">.</span><span class="n">result</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="k">await</span> <span class="n">channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">text_to_file</span><span class="p">(</span><span class="n">join_character</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">messages</span><span class="p">)))</span>
                        <span class="p">)</span>
                        <span class="k">break</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="Red.get_support_server_url">
<a class="viewcode-back" href="../../../framework_bot.html#starbot.core.bot.Red.get_support_server_url">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_support_server_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the support server URL for this bot.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">support_server</span><span class="p">()</span></div>
</div>

</pre></div>

           </div>
          </div>
<a href="https://github.com/Cog-Creators/StarBot">
    <img style="position: absolute; top: 0; right: 0; border: 0;"
    src="https://github.blog/wp-content/uploads/2008/12/forkme_right_darkblue_121621.png?resize=149%2C149"
    class="attachment-full size-full" alt="Fork me on GitHub">
</a>

          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2024, Cog Creators.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>